
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>iOS Core Animation Advanced Techniques - Light's Blog</title>
  <meta name="author" content="Light">

  
  <meta name="description" content="iOS Core Animation Advanced Techniques">
  <meta name="keywords" content="sxgfxm,CALayer,UIView,Core Animation">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sxgfxm.github.io/blog/2017/02/20/ios-core-animation-advanced-techniques/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Light's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript">

function addBlankTargetForLinks () {

  $('a[href^="http"]').each(function(){

      $(this).attr('target', '_blank');

  });

}

$(document).bind('DOMNodeInserted', function(event) {

  addBlankTargetForLinks();

});

</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-86198628-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <meta name="baidu-site-verification" content="vgau9BNOtE" />
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Light's Blog</a></h1>
  
    <h2>The best or nothing.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <!-- <input type="hidden" name="sitesearch" value="sxgfxm.github.io"> -->
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">iOS Core Animation Advanced Techniques</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-02-20T22:10:40+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:10 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h1>Introduction</h1>

<p>本文主要为<strong>iOS Core Animation Advanced Techniques</strong>的笔记。</p>

<!--more-->


<h2>CALayer和UIView</h2>

<p>1.CALayer和UIView有什么关系？<br/>
UIView是对CALayer的封装，可以处理touch事件。<br/>
UIView是通过CALayer显示的。<br/>
UIView会自动重绘，CALayer需要手动重绘。<br/>
UIView是二维的，CALayer是三维的。<br/>
UIView支持autoLayout，CALayer不支持autoLayout。<br/>
2、CALayer的特性是什么？<br/>
可以绘制阴影、圆角、彩色边框；<br/>
可以处理3D变换；<br/>
可以处理非矩形边界；<br/>
可以处理透明遮罩；<br/>
可以处理多级非线性动画。<br/>
3、什么情况下会使用CALayer？<br/>
开发跨平台应用；<br/>
与特殊图层打交道；<br/>
提高性能。<br/>
4、为什么不把CALayer和UIView合二为一，而是有两套并列的层次结构？<br/>
把绘图和事件处理分离，是为了减少重复的代码。<br/>
在Mac OS上已经有CALayer，但在iPhone和Mac的交互是有本质不同的，所以UIView来处理。</p>

<h3>Contents</h3>

<p>1、如何让UIView等比清晰显示图片的右上角？<br/>
<code>layer.contents = (__bridge id)image.CGImage;</code><br/>
<code>layer.contentsGravity = kCAGravityResizeAspect;</code><br/>
<code>layer.contentsScale = [UIScreen mainScreen].scale;</code><br/>
<code>layer.contentsRect = CGRectMake(0.5,0,0.5,0.5);</code><br/>
2、-drawRect:方法的作用是什么？空的-drawRect:方法有何影响？<br/>
UIView自定义绘图。<br/>
如果自己实现-drawRect:方法，会为view创建一个backing image。<br/>
3、如何绘制带阴影的有裁剪效果的UIView？<br/>
设置layer阴影；<br/>
通过layer代理绘图；</p>

<h3>Geometry</h3>

<p>1、center, position的区别？<br/>
center对应view；position对应layer。<br/>
两者都表示anchorPoint在父视图中的位置。<br/>
因为UIView并没有暴露anchorPoint属性，所以被称作center。<br/>
2、anchorPoint理解？<br/>
控制点。<br/>
3、frame的理解？<br/>
是否可以改变view的frame而不改变layer的frame。<br/>
frame是由bounds，position和transform计算而来的。<br/>
4、坐标转换？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (CGPoint)convertPoint:(CGPoint)point fromLayer:(CALayer *)layer;
</span><span class='line'>- (CGPoint)convertPoint:(CGPoint)point toLayer:(CALayer *)layer;
</span><span class='line'>- (CGRect)convertRect:(CGRect)rect fromLayer:(CALayer *)layer;
</span><span class='line'>- (CGRect)convertRect:(CGRect)rect toLayer:(CALayer *)layer;</span></code></pre></td></tr></table></div></figure>


<p>5、坐标翻转</p>

<p><code>layer.geometryFlipped = YES;</code></p>

<p>6、如何在不修改layer层次结构的情况下，使下层的layer在顶层显示？<br/>
zPosition，用来改变layer的显示层次；<br/>
zAnchorPoint?<br/>
7、如何用CALayer实现touch handling？<br/>
-containsPoint:<br/>
-hitTest: 严格按照layer tree的层次结构判断，与zPosition无关。<br/>
8、如何实现CALayer的自动布局？<br/>
<code>- (void)layoutSublayersOfLayer:(CALayer *)layer;</code>，<br/>
当bounds改变或调用<code>-setNeedsLayout</code>时触发。</p>

<h3>Visual Effects</h3>

<p>1、如何实现圆角？曲率不同的圆角？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>layer.cornerRadius = 5.0f;
</span><span class='line'>layer.maskToBounds = YES;</span></code></pre></td></tr></table></div></figure>


<p>2、如何实现彩色边框？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>layer.borderWidth = 1;
</span><span class='line'>layer.borderColor = [UIColor redColor].CGColor;</span></code></pre></td></tr></table></div></figure>


<p>border只与bounds相关。<br/>
3、如何添加阴影？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>layer.shadowOpacity = 1;
</span><span class='line'>layer.shadowColor = [UIColor redColor].CGColor;
</span><span class='line'>layer.shadowOffset = CGSizeMake(0,1);
</span><span class='line'>layer.shadowRadius = 5;</span></code></pre></td></tr></table></div></figure>


<p>shadow与形状有关。<br/>
如何添加maskToBounds = YES时的阴影？<br/>
两层。<br/>
如何绘制不规则阴影？<br/>
<code>layer.shadowPath = path;</code>
4、不规则裁剪，动态裁剪<br/>
<code>layer.mask = maskLayer;</code>
5、scaling filter<br/>
kCAFilterNearest，适用于无对角线，对比明显的图片，保留像素，像素图；<br/>
kCAFilterLinear，适用于复杂图片，保留轮廓；<br/>
6、group opacity<br/>
opacity作用于层次结构，0.5+0.5 = 0.75<br/>
UIViewGroupOpacity = YES，Info.plist，降低性能。<br/>
<code>layer.shouldRasterize = YES</code>，在渲染前合成一张图片，防止alpha值影响。<br/>
<code>layer.rasterizationScale = [UIScreen mainScreen].scale;</code></p>

<h3>Transform</h3>

<p>1、Affine Transforms，仿射变换<br/>
CGAffineTransform，用来表示二维旋转，缩放和变换。对一个2D点做2D变换。<br/>
它是一个3行2列的矩阵。<br/>
做运算时需要扩展。<br/>
变换前平行的线，变换后依然平行。<br/>
2、创建仿射变换</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CGAffineTransformMakeRotation(CGFloat angle);
</span><span class='line'>CGAffineTransformMakeScale(CGFloat sx, CGFloat sy);
</span><span class='line'>CGAffineTransformMakeTranslation(CGFloat tx, CGFloat ty);</span></code></pre></td></tr></table></div></figure>


<p>角度弧度转换</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define RADIANS_TO_DEGREES(x) ((x)/M_PI*180.0)
</span><span class='line'>#define DEGREES_TO_RADIANS(x) ((x)/180.0*M_PI)</span></code></pre></td></tr></table></div></figure>


<p>3、连续变换</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CGAffineTransformRotate(CGAffineTransform t, CGFloat angle);
</span><span class='line'>CGAffineTransformScale(CGAffineTransform t, CGFloat sx, CGFloat sy);
</span><span class='line'>CGAffineTransformTranslate(CGAffineTransform t, CGFloat tx, CGFloat ty);
</span><span class='line'>或
</span><span class='line'>CGAffineTransformConcat(CGAffineTransform t1, CGAffineTransform t2);</span></code></pre></td></tr></table></div></figure>


<p>单位矩阵，CGAffineTransformIdentity。<br/>
变换顺序不同，结果不同。因为矩阵运算不符合交换律。<br/>
4、shear变换</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CGAffineTransform CGAffineTransformMakeShear(CGFloat x, CGFloat y) {
</span><span class='line'>  CGAffineTransform transform = CGAffineTransformIdentity; transform.c = -x;
</span><span class='line'>  transform.b = y;
</span><span class='line'>  return transform;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>5、3D Transform，3D变换<br/>
CATransform3D，是一个4行4列的矩阵。对一个3D点做3D变换。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CATransform3DMakeRotation(CGFloat angle, CGFloat x, CGFloat y, CGFloat z);
</span><span class='line'>CATransform3DMakeScale(CGFloat sx, CGFloat sy, CGFloat sz);
</span><span class='line'>CATransform3DMakeTranslation(Gloat tx, CGFloat ty, CGFloat tz);</span></code></pre></td></tr></table></div></figure>


<p>6、Perspective Projection，透视<br/>
矩阵中m34的值用来设置透视，值越小透视约明显，值越大透视越不明显。<br/>
7、The Vanishing Point，消失点<br/>
定义消失点为anchorPoint。<br/>
8、sublayer共享透视视角<br/>
设置sublayerTransform<br/>
9、Backfaces，<br/>
layer是两面都有的。可以设置取消。</p>

<h2>Specialized Layers</h2>

<h3>CAShapeLayer</h3>

<p>CAShapeLayer比Core Graphics效率更高，硬件加速；<br/>
CAShapeLayer节省内存空间，不会创建backing image；<br/>
CAShapeLayer不会受bounds限制，Core Graphics不行；<br/>
CAShapeLayer不会变换后不会像素化。<br/>
基本使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CAShapeLayer *shapeLayer = [CAShapeLayer layer];
</span><span class='line'>shapeLayer.strokeColor = [UIColor redColor].CGColor;
</span><span class='line'>shapeLayer.fillColor = [UIColor clearColor].CGColor;
</span><span class='line'>shapeLayer.lineWidth = 5;
</span><span class='line'>shapeLayer.lineJoin = kCALineJoinRound;
</span><span class='line'>shapeLayer.lineCap = kCALineCapRound;
</span><span class='line'>shapeLayer.path = path.CGPath;</span></code></pre></td></tr></table></div></figure>


<h3>CATextLayer</h3>

<p>UILabel，通过layer代理方法使用CG绘制string。<br/>
CATextLayer，用于显示文字，特效，效率比UILabel高。<br/>
基本使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//set text attributes
</span><span class='line'>textLayer.foregroundColor = [UIColor blackColor].CGColor;
</span><span class='line'>textLayer.alignmentMode = kCAAlignmentJustified;
</span><span class='line'>textLayer.wrapped = YES;
</span><span class='line'>
</span><span class='line'>//choose a font
</span><span class='line'>UIFont *font = [UIFont systemFontOfSize:15];
</span><span class='line'>
</span><span class='line'>//set layer font
</span><span class='line'>CFStringRef fontName = (__bridge CFStringRef)font.fontName;
</span><span class='line'>CGFontRef fontRef = CGFontCreateWithFontName(fontName);
</span><span class='line'>textLayer.font = fontRef;
</span><span class='line'>textLayer.fontSize = font.pointSize;
</span><span class='line'>CGFontRelease(fontRef);
</span><span class='line'>
</span><span class='line'>//text
</span><span class='line'>textLayer.string = @"Text";
</span><span class='line'>
</span><span class='line'>//scale
</span><span class='line'>textLayer.contentsScale = [UIScreen mainScreen].scale;</span></code></pre></td></tr></table></div></figure>


<p>富文本：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//create attributed string
</span><span class='line'>NSMutableAttributedString *string = nil;
</span><span class='line'>string = [[NSMutableAttributedString alloc] initWithString:text];
</span><span class='line'>
</span><span class='line'>//convert UIFont to a CTFont
</span><span class='line'>CFStringRef fontName = (__bridge CFStringRef)font.fontName; CGFloat fontSize = font.pointSize;
</span><span class='line'>CTFontRef fontRef = CTFontCreateWithName(fontName, fontSize, NULL);
</span><span class='line'>
</span><span class='line'>//set text attributes
</span><span class='line'>NSDictionary *attribs = @{
</span><span class='line'>  (__bridge id)kCTForegroundColorAttributeName:(__bridge id)[UIColor blackColor].CGColor,
</span><span class='line'>  (__bridge id)kCTFontAttributeName: (__bridge id)fontRef
</span><span class='line'>};
</span><span class='line'>[string setAttributes:attribs range:NSMakeRange(0, [text length])];
</span><span class='line'>attribs = @{
</span><span class='line'>  (__bridge id)kCTForegroundColorAttributeName: (__bridge id)[UIColor redColor].CGColor,
</span><span class='line'>  (__bridge id)kCTUnderlineStyleAttributeName: @(kCTUnderlineStyleSingle),
</span><span class='line'>  (__bridge id)kCTFontAttributeName: (__bridge id)fontRef
</span><span class='line'>};
</span><span class='line'>[string setAttributes:attribs range:NSMakeRange(6, 5)];
</span><span class='line'>
</span><span class='line'>//release the CTFont we created earlier
</span><span class='line'>CFRelease(fontRef);
</span><span class='line'>
</span><span class='line'>//set layer text
</span><span class='line'>textLayer.string = string;</span></code></pre></td></tr></table></div></figure>


<p>修改view的根layer。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (Class)layerClass {
</span><span class='line'>  //this makes our label create a CATextLayer
</span><span class='line'>  //instead of a regular CALayer for its backing layer
</span><span class='line'>  return [CATextLayer class];
</span><span class='line'>}
</span><span class='line'>- (CATextLayer *)textLayer {
</span><span class='line'>  return (CATextLayer *)self.layer;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>CATransformLayer</h3>

<p>保存变换后的layer</p>

<h3>CAGradientLayer</h3>

<p>用于绘制渐变层。<br/>
线性渐变。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//create gradient layer and add it to our container view
</span><span class='line'>CAGradientLayer *gradientLayer = [CAGradientLayer layer];
</span><span class='line'>gradientLayer.frame = self.containerView.bounds;
</span><span class='line'>[self.containerView.layer addSublayer:gradientLayer];
</span><span class='line'>
</span><span class='line'>//set gradient colors
</span><span class='line'>gradientLayer.colors = @[
</span><span class='line'>  (__bridge id)[UIColor redColor].CGColor,
</span><span class='line'>  (__bridge id)[UIColor blueColor].CGColor,
</span><span class='line'>  (__bridge id)[UIColor greenColor].CGColor
</span><span class='line'>];
</span><span class='line'>
</span><span class='line'>//set locations
</span><span class='line'>gradientLayer.locations = @[@0.0, @0.25, @0.5];
</span><span class='line'>
</span><span class='line'>//set gradient start and end points
</span><span class='line'>gradientLayer.startPoint = CGPointMake(0, 0);
</span><span class='line'>gradientLayer.endPoint = CGPointMake(1, 1);</span></code></pre></td></tr></table></div></figure>


<p>放射性渐变。</p>

<h3>CAReplicatorLayer</h3>

<p>用于高效绘制相似的layer。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//create a replicator layer and add it to our view
</span><span class='line'>CAReplicatorLayer *replicator = [CAReplicatorLayer layer];
</span><span class='line'>replicator.frame = self.containerView.bounds;
</span><span class='line'>[self.containerView.layer addSublayer:replicator];
</span><span class='line'>
</span><span class='line'>//configure the replicator
</span><span class='line'>replicator.instanceCount = 10;
</span><span class='line'>
</span><span class='line'>//apply a transform for each instance
</span><span class='line'>CATransform3D transform = CATransform3DIdentity;
</span><span class='line'>transform = CATransform3DTranslate(transform, 0, 200, 0);
</span><span class='line'>transform = CATransform3DRotate(transform, M_PI / 5.0, 0, 0, 1);
</span><span class='line'>transform = CATransform3DTranslate(transform, 0, -200, 0);
</span><span class='line'>replicator.instanceTransform = transform;
</span><span class='line'>
</span><span class='line'>//apply a color shift for each instance
</span><span class='line'>replicator.instanceBlueOffset = -0.1;
</span><span class='line'>replicator.instanceGreenOffset = -0.1;
</span><span class='line'>
</span><span class='line'>//create a sublayer and place it inside the replicator
</span><span class='line'>CALayer *layer = [CALayer layer];
</span><span class='line'>layer.frame = CGRectMake(100.0f, 100.0f, 100.0f, 100.0f);
</span><span class='line'>layer.backgroundColor = [UIColor whiteColor].CGColor;
</span><span class='line'>[replicator addSublayer:layer];</span></code></pre></td></tr></table></div></figure>


<p>绘制镜面</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (Class)layerClass {
</span><span class='line'>  return [CAReplicatorLayer class];
</span><span class='line'>}
</span><span class='line'>- (void)setUp {
</span><span class='line'>  //configure replicator
</span><span class='line'>  CAReplicatorLayer *layer = (CAReplicatorLayer *)self.layer;
</span><span class='line'>  layer.instanceCount = 2;
</span><span class='line'>
</span><span class='line'>  //move reflection instance below original and flip vertically
</span><span class='line'>  CATransform3D transform = CATransform3DIdentity;
</span><span class='line'>  CGFloat verticalOffset = self.bounds.size.height + 2;
</span><span class='line'>  transform = CATransform3DTranslate(transform, 0, verticalOffset, 0);
</span><span class='line'>  transform = CATransform3DScale(transform, 1, -1, 0);
</span><span class='line'>  layer.instanceTransform = transform;
</span><span class='line'>
</span><span class='line'>  //reduce alpha of reflection layer
</span><span class='line'>  layer.instanceAlphaOffset = -0.6;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (id)initWithFrame:(CGRect)frame {
</span><span class='line'>  //this is called when view is created in code
</span><span class='line'>  if ((self = [super initWithFrame:frame])) {
</span><span class='line'>    [self setUp];
</span><span class='line'>  }
</span><span class='line'>  return self;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>CAScrollLayer</h3>

<p>用于绘制可以滑动的layer。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (Class)layerClass {
</span><span class='line'>  return [CAScrollLayer class];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)setUp {
</span><span class='line'>  //enable clipping
</span><span class='line'>  self.layer.masksToBounds = YES;
</span><span class='line'>
</span><span class='line'>  //attach pan gesture recognizer
</span><span class='line'>  UIPanGestureRecognizer *recognizer = nil;
</span><span class='line'>  recognizer = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(pan:)];
</span><span class='line'>  [self addGestureRecognizer:recognizer];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (id)initWithFrame:(CGRect)frame {
</span><span class='line'>  //this is called when view is created in code
</span><span class='line'>  if ((self = [super initWithFrame:frame])) {
</span><span class='line'>    [self setUp];
</span><span class='line'>  }
</span><span class='line'>  return self;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)pan:(UIPanGestureRecognizer *)recognizer {
</span><span class='line'>  //get the offset by subtracting the pan gesture
</span><span class='line'>  //translation from the current bounds origin
</span><span class='line'>  CGPoint offset = self.bounds.origin;
</span><span class='line'>  offset.x -= [recognizer translationInView:self].x;
</span><span class='line'>  offset.y -= [recognizer translationInView:self].y;
</span><span class='line'>
</span><span class='line'>  //scroll the layer
</span><span class='line'>  [(CAScrollLayer *)self.layer scrollToPoint:offset];
</span><span class='line'>
</span><span class='line'>  //reset the pan gesture translation
</span><span class='line'>  [recognizer setTranslation:CGPointZero inView:self];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>CATiledLayer</h3>

<p>用于加载尺寸巨大的图片。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//add the tiled layer
</span><span class='line'>CATiledLayer *tileLayer = [CATiledLayer layer];
</span><span class='line'>tileLayer.frame = CGRectMake(0, 0, 2048, 2048);
</span><span class='line'>tileLayer.delegate = self; [self.scrollView.layer addSublayer:tileLayer];
</span><span class='line'>
</span><span class='line'>//configure the scroll view
</span><span class='line'>self.scrollView.contentSize = tileLayer.frame.size;
</span><span class='line'>
</span><span class='line'>//draw layer
</span><span class='line'>[tileLayer setNeedsDisplay];
</span><span class='line'>
</span><span class='line'>- (void)drawLayer:(CATiledLayer *)layer inContext:(CGContextRef)ctx {
</span><span class='line'>  //determine tile coordinate
</span><span class='line'>  CGRect bounds = CGContextGetClipBoundingBox(ctx);
</span><span class='line'>  NSInteger x = floor(bounds.origin.x / layer.tileSize.width);
</span><span class='line'>  NSInteger y = floor(bounds.origin.y / layer.tileSize.height);
</span><span class='line'>
</span><span class='line'>  //load tile image
</span><span class='line'>  NSString *imageName = [NSString stringWithFormat: @"Snowman_%02i_%02i, x, y];
</span><span class='line'>  NSString *imagePath = [[NSBundle mainBundle] pathForResource:imageName ofType:@"jpg"];
</span><span class='line'>  UIImage *tileImage = [UIImage imageWithContentsOfFile:imagePath];
</span><span class='line'>
</span><span class='line'>  //draw tile
</span><span class='line'>  UIGraphicsPushContext(ctx);
</span><span class='line'>  [tileImage drawInRect:bounds];
</span><span class='line'>  UIGraphicsPopContext();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>CAEmitterLayer</h3>

<p>粒子特效。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//create particle emitter layer
</span><span class='line'>CAEmitterLayer *emitter = [CAEmitterLayer layer];
</span><span class='line'>emitter.frame = self.containerView.bounds;
</span><span class='line'>[self.containerView.layer addSublayer:emitter];
</span><span class='line'>
</span><span class='line'>//configure emitter
</span><span class='line'>emitter.renderMode = kCAEmitterLayerAdditive;
</span><span class='line'>emitter.emitterPosition = CGPointMake(emitter.frame.size.width / 2.0,emitter.frame.size.height / 2.0);
</span><span class='line'>
</span><span class='line'>//create a particle template
</span><span class='line'>CAEmitterCell *cell = [[CAEmitterCell alloc] init];
</span><span class='line'>cell.contents = (__bridge id)[UIImage imageNamed:@"Spark.png"].CGImage;
</span><span class='line'>cell.birthRate = 150;
</span><span class='line'>cell.lifetime = 5.0;
</span><span class='line'>cell.color = [UIColor colorWithRed:1 green:0.5 blue:0.1 alpha:1.0].CGColor;
</span><span class='line'>cell.alphaSpeed = -0.4;
</span><span class='line'>cell.velocity = 50;
</span><span class='line'>cell.velocityRange = 50;
</span><span class='line'>cell.emissionRange = M_PI * 2.0;
</span><span class='line'>
</span><span class='line'>//add particle template to emitter
</span><span class='line'>emitter.emitterCells = @[cell];</span></code></pre></td></tr></table></div></figure>


<h3>AVPlayerLayer</h3>

<p>播放视频。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//get video URL
</span><span class='line'>NSURL *URL = [[NSBundle mainBundle] URLForResource:@"Ship" withExtension:@"mp4"];
</span><span class='line'>
</span><span class='line'>//create player and player layer
</span><span class='line'>AVPlayer *player = [AVPlayer playerWithURL:URL];
</span><span class='line'>AVPlayerLayer *playerLayer = [AVPlayerLayer playerLayerWithPlayer:player];
</span><span class='line'>
</span><span class='line'>//set player layer frame and attach it to our view
</span><span class='line'>playerLayer.frame = self.containerView.bounds;
</span><span class='line'>[self.containerView.layer addSublayer:playerLayer];
</span><span class='line'>
</span><span class='line'>//play the video
</span><span class='line'>[player play];</span></code></pre></td></tr></table></div></figure>


<h2>Implicit Animations</h2>

<p>隐式动画。改变支持动画的属性，自动生成动画。<br/>
duration -> transaction，默认为0.25秒<br/>
type -> layer action<br/>
transaction只能begin和commit。<br/>
每次runloop会执行一次transaction。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//begin a new transaction
</span><span class='line'>[CATransaction begin];
</span><span class='line'>
</span><span class='line'>//set the animation duration to 1 second
</span><span class='line'>[CATransaction setAnimationDuration:1.0];
</span><span class='line'>
</span><span class='line'>//add the spin animation on completion
</span><span class='line'>[CATransaction setCompletionBlock:^{
</span><span class='line'>  //rotate the layer 90 degrees
</span><span class='line'>  CGAffineTransform transform = self.colorLayer.affineTransform;
</span><span class='line'>  transform = CGAffineTransformRotate(transform, M_PI_2);
</span><span class='line'>  self.colorLayer.affineTransform = transform;
</span><span class='line'>}];
</span><span class='line'>
</span><span class='line'>//randomize the layer background color
</span><span class='line'>CGFloat red = arc4random() / (CGFloat)INT_MAX;
</span><span class='line'>CGFloat green = arc4random() / (CGFloat)INT_MAX;
</span><span class='line'>CGFloat blue = arc4random() / (CGFloat)INT_MAX;
</span><span class='line'>self.colorLayer.backgroundColor = [UIColor colorWithRed:red green:green blue:blue alpha:1.0].CGColor;
</span><span class='line'>
</span><span class='line'>//commit the transaction
</span><span class='line'>[CATransaction commit];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>隐式动画流程：<br/>
-actionForLayer:forKey<br/>
actions dictionary<br/>
style dictionary<br/>
-defaultActionForKey:</p>

<p>UIView默认不开启隐式动画。<br/>
CATransition</p>

<p>修改layer属性会立即生效，但是并不会立刻显示。</p>

<p>presentation layer，记录当前layer在哪儿，同步动画和处理点击事件。<br/>
model layer，记录当前layer要去哪儿</p>

<h2>Explicit Aniamtions</h2>

<p>显式动画。</p>

<h3>Property Animations</h3>

<p>只与一个属性相关的动画。</p>

<p>CABasicAnimation : CAPropertyAnimation : CAAnimation<br/>
fromeValue<br/>
toValue<br/>
byValue</p>

<p>Animations只作用于presentation，而不作用于model。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)applyBasicAnimation:(CABasicAnimation *)animation toLayer:(CALayer *)layer{
</span><span class='line'>  //set the from value (using presentation layer if available)  
</span><span class='line'>  animation.fromValue = [layer.presentationLayer ?: layer valueForKeyPath:animation.keyPath];
</span><span class='line'>
</span><span class='line'>  //update the property in advance
</span><span class='line'>  //note: this approach will only work if toValue != nil
</span><span class='line'>  [CATransaction begin];
</span><span class='line'>  [CATransaction setDisableActions:YES];
</span><span class='line'>  [layer setValue:animation.toValue forKeyPath:animation.keyPath];
</span><span class='line'>  [CATransaction commit];
</span><span class='line'>
</span><span class='line'>  //apply animation to layer
</span><span class='line'>  [layer addAnimation:animation forKey:nil];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>CAKeyframeAnimation : CAPropertyAnimation : CAAnimation<br/>
values<br/>
path<br/>
rotationMode = kCAAnimationRotateAuto</p>

<p>CAAnimationGroup<br/>
animations<br/>
duration</p>

<p>Transitions<br/>
CATransition : CAAnimation<br/>
type<br/>
subtype</p>

<p>视图控制器切换时使用，效果更平滑；</p>

<h3>Cancel animations</h3>

<p><code>-removeAnimationForKey: </code></p>

<h2>Layer time</h2>

<h2>Tuning for speed</h2>

<p>合理分配绘图任务至CPU和GPU。</p>

<h3>The Stages of an Animation</h3>

<p>Layout：setup layers<br/>
Display：draw backing image，call -drawRect:<br/>
Prepare：prepare send animation data to render server<br/>
Commit：package up and send over IPC<br/>
render server form render tree:<br/>
  calculate intermediate values<br/>
  render to screen<br/>
只有最后一步通过GPU处理。<br/>
开发者只能控制前两步，layout和display。</p>

<p>影响GPU绘图效率的因素：<br/>
1、过多的layer；<br/>
2、过多的半透明layer；<br/>
3、离屏绘制，如圆角、遮罩、阴影、光栅化；<br/>
4、过大的图片。</p>

<p>影响CPU绘图效率的因素：<br/>
1、复杂的layout计算；<br/>
2、view的懒加载，从数据库获取数据，从nib中加载view，加载图片；<br/>
3、Core Graphics 绘图；<br/>
4、图片解压缩；</p>

<p>IO限制因素：<br/>
IO操作耗时严重；</p>

<p>通过测量发现实际的瓶颈点：<br/>
1、在真机上测试，使用release版本，在低性能机器上测试；<br/>
2、保持稳定的帧率；<br/>
3、instrument：</p>

<pre><code>Time Profiler：查看CPU时间开销；
    Separate by Thread：按线程将方法分组；
    Hide System Libraries：隐藏系统库；
    Show Obj-C Only：只显示OC方法调用；
Core Animation：查看Core Animation性能；
    Color Blended Layers：标记出混合的图层，从绿到红表示严重程度，最好没有；
    Color Hits Green and Misses Red：标记出重复缓存的图层；
    Color Copied Images：标记出backing image，最好没有；
    Color Immediately：随时反馈；
    Color Misaligned Images：标记非正确缩放的图片；
    Color Offscreen-Rendered Yellow：标记出需要离屏绘制的layer，通过栅格化优化；
    Color OpenGL Fast Path Blue：标记出OpenGL绘图；
    Flash Updated Regions：标记出重绘的layer，最好没有；
OpenGL ES Driver：查看GPU性能；
    Tiler Utilization
    Renderer Utilization
组合使用效果更佳。
</code></pre>

<p>优化方法：<br/>
cache offscreen render layer：</p>

<pre><code>layer.shouldRasterize = YES;
layer.rasterizationScale = [UIScreen mainScreen].scale;
</code></pre>

<h2>Efficient Drawing</h2>

<h3>Software Drawing</h3>

<p>速度慢并且需要大量内存空间。<br/>
少写drawRect方法。</p>

<h3>Vector Graphics</h3>

<p>多边形；<br/>
对角线和曲线；<br/>
文字；<br/>
渐变。<br/>
使用CAShapeLayer</p>

<h3>Dirty Rectangles</h3>

<p>需要重绘的区域<br/>
调用-setNeedsDisplayInRect:方法指定重绘区域。</p>

<h3>Asynchronous Drawing</h3>

<p>在子线程绘图，将结果直接作为layer的contents。<br/>
CATiledLayer。<br/>
drawsAsynchronously属性。</p>

<h2>Image IO</h2>

<pre><code>//  通过tag防止重复创建
UIImageView *imageView = (UIImageView *)[cell viewWithTag:imageTag];
if (!imageView){
  imageView = [UIImageView alloc] init];
  [cell.contentView addSubview:imageView];
}
</code></pre>

<h3>Loading and Latency</h3>

<p>button的响应时间要保持在0.2秒以下。</p>

<h3>Threaded Loading</h3>

<p>gcd</p>

<pre><code>//  标记cell
cell.tag = indexPath.row;
imageView.image = nil;
//  异步加载图片
dispatch_aysnc(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW),0),^{
  //  加载图片
  NSInteger index = indexPath.row;
  NSString *imagePath = self.imagePaths[index];
  UIImageView *image = [UIImage imageWithContentsOfFile:imagePath];

  //  在主线程显示图片
  dispatch_async(dispatch_get_main_queue(),^{
    if (index == cell.tag){
      imageView.image = image;
    }
  });
});
</code></pre>

<h3>Deferred Decompression</h3>

<p>PNG图片大，但解压快；<br/>
JPEG图片小，但解压慢。<br/>
图片通常在需要绘制前才开始解压。<br/>
[UIImage imageWithName:imageName] 该方法载入图片后即开始解压。<br/>
layer的contents或UIImageView的image。<br/>
ImageIO.framework</p>

<pre><code>NSInteger index = indexPath.row;
NSURL *imageURL = [NSURL fileURLWithPath:self.imagePaths[index]];
NSDictionary *options = @{(__bridge id)kCGImageSourceShouldCache:@YES};
CGImageSourceRef source = CGImageSourceCreateWithURL((__bridge CFURLRef)imageURL,NULL);
CGImageRef imageRef = CGImageSourceCreateImageAtIndex(source,0,(__bridge CFDictionaryRef)options);
UIImage *image = [UIImage imageWithCGImage:imageRef];
CGImageRelease(imageRef);
CFRelease(source);
</code></pre>

<p>NSCache</p>

<h2>Layer Performance</h2>

<p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2017/02/20/ios-core-animation-advanced-techniques/'>http://sxgfxm.github.io/blog/2017/02/20/ios-core-animation-advanced-techniques/</a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'>http://sxgfxm.github.io</a>
  </p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Light</span></span>

      




<time class='entry-date' datetime='2017-02-20T22:10:40+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:10 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ios/'>ios</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/02/10/export-music-from-itunes-to-local-apps-sandbox-on-iphone/" title="Previous Post: Export Music from Itunes to Local App's Sandbox on iPhone">&laquo; Export Music from Itunes to Local App's Sandbox on iPhone</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/02/25/ios-system-authorization/" title="Next Post: iOS System Authorization">iOS System Authorization &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
 <h1>Introduction</h1>

<li>
	<span style="color:#222222;font-family:inherit;font-size:18px;font-style:inherit;font-weight:inherit;line-height:1.5;">Light</br></span>
	<span style="font-family:inherit;font-style:inherit;font-weight:inherit;color:#222222;font-size:18px;line-height:1.5;">iOS开发工程师</br></span>
	<span style="font-family:inherit;font-style:inherit;font-weight:inherit;color:#222222;font-size:18px;line-height:1.5;">现就职于 出门问问</br></span>
</li>

</section><section>
 <h1>Categories</h1>
 <ul id="categories">
  <li class='category'><a href='/blog/categories/componentkit/'>componentkit (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (32)</a></li>
<li class='category'><a href='/blog/categories/markdown/'>markdown (1)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (3)</a></li>

 </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/07/10/ioszhi-shi-xiao-ji-170703/">iOS知识小集-170703</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/07/03/ioszhi-shi-xiao-ji-170626/">iOS知识小集-170626</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/26/ioszhi-shi-xiao-ji-170619/">iOS知识小集-170619</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/16/ioszhi-shi-xiao-ji-170612/">iOS知识小集-170612</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/13/componentkit-tutorial/">ComponentKit Tutorial</a>
      </li>
    
  </ul>
</section>
<section>
 <h1>他山之石</h1>
	<li>
		<a href="http://southpeak.github.io/">南峰子的技术博客</a></br>
	</li>
	<li>
		<a href="http://www.tutorialspoint.com/index.htm">TutorailSpoint</a></br>
	</li>
	<li>
		<a href="http://stackoverflow.com/">StackOverflow</a></br>
	</li>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sxgfxm">@sxgfxm</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sxgfxm',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section>
 <h1>Visitors</h1>
	<a href="http://info.flagcounter.com/CVgH"><img src="http://s09.flagcounter.com/count2/CVgH/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_0/labels_0/pageviews_0/flags_0/percent_0/" alt="Flag Counter" border="0"></a>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Light -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86198628-1', 'auto');
  ga('send', 'pageview');

</script>

</footer>
  











</body>
</html>
