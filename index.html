
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Light's Blog</title>
  <meta name="author" content="Light">

  
  <meta name="description" content="sxgfxm, Light's Blog">
  <meta name="keywords" content="iOS, sxgfxm,Light's Blog, octopress, markdown, objectiveC">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sxgfxm.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Light's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script type="text/javascript">

function addBlankTargetForLinks () {

  $('a[href^="http"]').each(function(){

      $(this).attr('target', '_blank');

  });

}

$(document).bind('DOMNodeInserted', function(event) {

  addBlankTargetForLinks();

});

</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-86198628-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <meta name="baidu-site-verification" content="vgau9BNOtE" />
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Light's Blog</a></h1>
  
    <h2>The best or nothing.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <!-- <input type="hidden" name="sitesearch" value="sxgfxm.github.io"> -->
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/">iOS知识小集-201912</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T12:04:23+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>12:04 pm</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.12.04</h2>

<p>ASR service 增加 enable remote silence。</p>

<h2>2019.12.06</h2>

<p>present 同一个VC会crash。<br/>
UI操作要放到主线程。</p>

<h2>2019.12.09</h2>

<h3>iOS 启动优化</h3>

<h4>启动过程</h4>

<p>冷启动：不在内存，也不存在进程。<br/>
热启动：APP结束后再启动，有部分在内存但没有进程存在。<br/>
resume：APP没结束，全在内存内存中，进程也存在。</p>

<p>iOS启动过程：<br/>
• 根据 info.plist 里的设置加载闪屏，建立沙箱，对权限进行检查等；<br/>
• 加载 Mach-O；<br/>
• 执行 attribute 的 constructor 函数；<br/>
• 加载类扩展；<br/>
• 加载 C++静态对象；<br/>
• 调用+load 函数；<br/>
• 执行 main 函数；<br/>
• Application 初始化，到 applicationDidFinishLaunchingWithOptions 执行完；<br/>
• 初始化帧渲染，到 viewDidAppear 执行完，用户可见可操作。</p>

<h4>分析工具</h4>

<p>Instruments，App launch。</p>

<h4>分析纬度</h4>

<p>线程是计算机资源调度和分配的基本单位，CPU 的使用情况会体现到线程上。</p>

<h4>主线程耗时：</h4>

<p>​    1、使用 <strong>Messier</strong> 生成 trace json 进行分析。<br/>
​    2、手动 hook objc_msgSend 生成 Objective-C 方法耗时数据分析。<em>GCDFetchFeed/SMCallTraceCore.c at master · ming1016/GCDFetchFeed · GitHub</em></p>

<h4>CPU：</h4>

<p>​    1、使用 <strong>Energy Log</strong> 检查 CPU 耗电，前台三分钟或者后台一分钟 CPU 线程连续占用80%以上判定为耗电，同事记录耗电线程堆栈供分析。<br/>
​    2、查看线程情况，<strong>task_theads</strong> 的 <strong>act_list</strong> 数组包含所有线程，使用 <strong>thread_info</strong> 的接口可以返回线程的基本信息 <strong>thread_basic_info_t</strong>。</p>

<h4>内存：</h4>

<p>​    1、查看 APP 内存真实使用情况，<strong>webkit/MemoryFootprintCocoa.cpp</strong>。<br/>
​    2、<strong>JetSam</strong> 会判断 APP 内存使用情况，超出阈值就会杀死APP。<br/>
​    3、<strong>NSProcessInfo</strong> 的 <strong>physicalMemory</strong> 表示设备物理内存大小。</p>

<h4>网络：</h4>

<p>​    1、使用 <strong>Fishhook</strong> hook 网络底层库 <strong>CFNetwork</strong>。<br/>
​    2、指标：DNS 时间，SSL 时间，首包时间，响应时间。</p>

<h4>I/O：</h4>

<p>​    1、使用 <strong>Frida</strong>，动态二进制插桩技术，在程序运行时区插入自定义代码获取 I/O 的耗时和处理数据大小等数据。<br/>
​    2、WWDC。</p>

<h4>延后任务管理</h4>

<p>对于分析后，没必要在启动阶段执行的方法，可以延后执行。一般创建四个队列：<br/>
• 异步串行队列：执行有依赖关系的任务。<br/>
• 异步并行队列：分组执行独立任务，限制任务数量，避免CPU和内存瞬时激增影响主线程用户操作。<br/>
• 闲时主线程串行队列：监听主线程 runloop 状态，在 <strong>kCFRunLoopBeforeWaiting</strong> 时开始执行闲时队列里的任务，在 <strong>kCFRunLoopAfterWaiting</strong> 是停止。<br/>
• 闲时异步串行队列：同上。</p>

<h4>优化后如何保持</h4>

<p>监控启动阶段方法耗时，出现异常快速定位。<br/>
通过 <strong>JSON</strong> 表示监控数据，自动化分析和定位。</p>

<h2>2019.12.10</h2>

<p>CLLocationManager 请求权限需要被强引用。</p>

<h2>2019.12.19</h2>

<h3>iOS 项目架构</h3>

<h4>小团队</h4>

<p>MVC<br/>
MVP<br/>
MVVM<br/>
MVCS</p>

<h3>大团队</h3>

<p>需要考虑如何划分模块粒度、如何分层、如何团队协作。</p>

<h4>划分模块粒度</h4>

<p>首先，模块划分需要遵循规范、清晰的原则。<br/>
其次，SOLID 原则。</p>

<ol>
<li>单一功能原则：对象功能要单一，不要在一个对象里添加很多功能。</li>
<li>开闭原则：扩展是开放的，修改是封闭的。</li>
<li>里氏替换原则：子类对象是可以替代基类对象的。</li>
<li>接口隔离原则：接口的用途要单一，不要在一个接口上根据不同的参数实现多个功能。</li>
<li>依赖反转原则：方法应该依赖抽象，不要依赖实例。iOS 开发就是高层业务方法依赖于协议。
最后，选择合适的粒度。iOS 组件，应该是包含 UI 控件，相关多个小功能的合集，是一种粒度适中的模块。</li>
</ol>


<p>先按物理划分为不同的pod库，然后梳理组件之间的逻辑关系，进行改造。</p>

<p>组件分层：<br/>
1. 底层是与业务无关的基础组件，比如网络和存储等；
2. 中间层是通用的业务组件，比如账号、埋点、支付、购物车等；
3. 最上层是迭代业务组件，更新频率最高。</p>

<p>被多个业务或团队使用的功能模块才需要做成组件。</p>

<h4>多团队分工</h4>

<p>首先，基建团队，负责业务无关的基础功能组件和业务相关的通用业务组件。<br/>
然后，业务团队，耦合度高的业务可以划分成单独的业务团队。<br/>
最后，人员相互流动，相互了解。</p>

<h4>理想的架构</h4>

<p>协议式架构：采用协议式编程思路，在编译层使用协议定义规范，实现可在不同地方，从而达到分布管理和维护组件的目的。<br/>
缺点：缺少统一调度层，导致难于集中管理；协议过于规范，不够灵活。</p>

<p>中间者架构：采用中间者统一管理的方式，来控制APP的整个生命周期中组件的调用关系。组件接口设计要保持一致。<br/>
CTMediator，运行时解耦。</p>

<h2>2019.12.31</h2>

<p>使用 <code>lame</code> 库，实现 pcm 流 转 mp3 流。<p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/">iOS知识小集-201911</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T12:03:37+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>12:03 pm</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.11.10</h2>

<p>xcode 11.2 无法上传APP至商店，需要使用 xcode 11.2.1 GM 版本上传。</p>

<h2>2019.11.11</h2>

<p>使用<code>GCDAsyncSocket</code>实现APP间通信，需要server端先开启，然后client端去连接。<br/>
可以在后台接收socket消息，但是如果被挂起后，将无法接收。<br/>
可以通过静默推送唤醒后台挂起应用，然后处理socket消息。</p>

<p>GATT 协议栈。</p>

<h2>2019.11.12</h2>

<p>iOS 可以实现多个APP作为中心设备与同一个周边设备建立BLE连接。<br/>
APP 可以获取当前正在连接的设备（retrieve），然后直接与之建立BLE连接。</p>

<h2>2019.11.13</h2>

<p><a href="https://apps.apple.com/cn/app/transporter/id1450874784?l=en&amp;mt=12">Transporter</a> 通过非命令行上传APP。</p>

<p><code>Google/SignIn</code>：3.0版本<br/>
<code>GoogleSignIn</code>：4.0版本  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/">iOS知识小集-201910</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T12:02:44+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>12:02 pm</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.10.09</h2>

<p>同一个ViewController不能连续present两个ViewController。<br/>
苹果的思维非同凡响，其实你只需要解散一个Modal View Controller就可以了。即处于最底层的View Controller，这样处于这个层之上的ModalView Controller统统会被解散。</p>

<h2>2019.10.21</h2>

<p><code>MPRemoteCommandCenter</code> 与 <code>AVAudioSession</code> 有关系。<br/>
如果增加<code>AVAudioSessionCategoryOptionMixWithOthers</code>，远程控制会消失。<br/>
I faced the same related issue. AVAudioSessionCategory should be mixwithothers, and you will no longer can update Lock Screen Control Center with info.</p>

<h2>2019.10.23</h2>

<p>以16进制查看文件<br/>
1、<code>vim</code>，<code>:%!xxd</code>转换为十六进制查看，<code>:%!xxd -r</code>转换为文本查看。<br/>
2、<code>hexdump -C file | more</code>。</p>

<h2>2019.10.31</h2>

<p>制定协议需要添加版本号。</p>

<p>当找不出问题时，考虑是否会受上下文影响。</p>

<p>BLE通知消息有Notify和Indicate两种。</p>

<p>iPhone 7及以下机型蓝牙版本为4.2，iPhone 8及以上机型蓝牙版本为5.0。</p>

<p>iPhone 6 BLE 发送数据发送间隔有最小限制30ms。</p>

<h2>2019.10.31</h2>

<p><strong>Symbolic Breakpoint</strong> 查找参数为nil的情况。  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201909/">iOS知识小集-201909</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:49:59+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:49 am</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201909/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201909/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.09.03</h2>

<h3>适配 iOS 13</h3>

<p>1、需要适配 dark mode。现强制设为非 dark mode；</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (@available(iOS 13.0, *)) {
</span><span class='line'>    self.window.overrideUserInterfaceStyle = UIUserInterfaceStyleLight;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>2、present 默认状态变为 卡片弹出，可下滑退出，可设置 <code>self.modalPresentationStyle = UIModalPresentationFullScreen;</code> <br/>
3、device token 解析方法改变：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;arpa/inet.h&gt;
</span><span class='line'>- (void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken
</span><span class='line'>{
</span><span class='line'>    if (![deviceToken isKindOfClass:[NSData class]]) return;
</span><span class='line'>    const unsigned *tokenBytes = [deviceToken bytes];
</span><span class='line'>    NSString *hexToken = [NSString stringWithFormat:@"%08x%08x%08x%08x%08x%08x%08x%08x",
</span><span class='line'>                          ntohl(tokenBytes[0]), ntohl(tokenBytes[1]), ntohl(tokenBytes[2]),
</span><span class='line'>                          ntohl(tokenBytes[3]), ntohl(tokenBytes[4]), ntohl(tokenBytes[5]),
</span><span class='line'>                          ntohl(tokenBytes[6]), ntohl(tokenBytes[7])];
</span><span class='line'>    NSLog(@"deviceToken:%@",hexToken);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>4、导航栏 label 需要设置frame，否则颜色会异常；<br/>
5、label add layer 会遮盖文字；<br/>
6、获取 keyWindow；<br/>
7、<code>Privacy - Bluetooth Always Usage Description</code>：增加该权限配置；<br/>
8、UITextfield placeholder 颜色；<br/>
9、NSData to HexString</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@implementation NSData (HexRepresentation)
</span><span class='line'>
</span><span class='line'>- (NSString *)hexString {
</span><span class='line'>    const unsigned char *bytes = (const unsigned char *)self.bytes;
</span><span class='line'>    NSMutableString *hex = [NSMutableString new];
</span><span class='line'>    for (NSInteger i = 0; i &lt; self.length; i++) {
</span><span class='line'>        [hex appendFormat:@"%02x", bytes[i]];
</span><span class='line'>    }
</span><span class='line'>    return [hex copy];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<h2>2019.09.04</h2>

<p>Wireless debug</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@startuml
</span><span class='line'>WWLoginController -&gt; WWThirdPartyLoginManager : press apple sign in button
</span><span class='line'>WWThirdPartyLoginManager --&gt; WWLoginController : apple sigin and send (userId, accessToken) back
</span><span class='line'>WWLoginController -&gt; WWThirdPartyAccountManager : send (loginType, userId, accessToken) to third party account manager
</span><span class='line'>WWThirdPartyAccountManager --&gt; WWLoginController : send (loginType, userId, accessToken) to server and send login status back
</span><span class='line'>WWLoginController -&gt; WWAccountRelatedManager : login succeeded, save (loginType, userId, responseObject)
</span><span class='line'>WWLoginController -&gt; WWRegisterInputNumberController : login failed, register phone number
</span><span class='line'>@enduml</span></code></pre></td></tr></table></div></figure>


<h2>2019.09.05</h2>

<h3>Apple Sign In</h3>

<p><strong>操作未完成</strong>：需要删除APP重新安装才生效；</p>

<h2>2019.09.06</h2>

<h3>Unit Test</h3>

<p>添加 Unit Test：创建工程时添加；添加新的 Target，选择 Test；<br/>
添加 测试文件：新建文件时选择测试文件；<br/>
can&rsquo;t find import files：运行一次就好了；</p>

<p><strong>如何测试代理</strong><br/>
<strong>如何测试block</strong></p>

<h2>2019.09.09</h2>

<p><strong>Failed to connect to github.com port 443: Operation timed out</strong>：<code>https://www.githubstatus.com/</code></p>

<h2>2019.09.11</h2>

<p><strong>生产者 - 消费者问题</strong>：cache 缓存数据，queue 读取数据，当cache为空时，queue应该等待，不能结束。
mark down mathjax：写数学公式。<br/>
<a href="https://stackoverflow.com/questions/30794479/the-sound-muted-after-playing-audio-with-audio-queue-on-ios-for-a-while?rq=1">音频流播放</a></p>

<h2>2019.09.16</h2>

<p><strong>TTS中断问题</strong>：先缓存0.5秒数据再开始播放。<br/>
<strong>AVAudioSessionErrorCodeCannotStartRecording（561145187）</strong>：无法后台语音识别。<br/>
<strong>AVAudioSessionErrorCodeCannotStartPlaying（561015905）</strong>：无法后台语音识别。</p>

<h2>2019.09.17</h2>

<p><strong>Error: Multiple commands produce</strong>：切换为 legacy build system。<br/>
<strong>(Enterprise) Sign In with Apple</strong>：去掉企业版capability中 sign in with apple 选项。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@startwbs
</span><span class='line'>* OTA
</span><span class='line'>** BLE Connection
</span><span class='line'>*** CSRConnectionManager \n -connectPeripheral
</span><span class='line'>*** CSRConnectionManager \n -addDelegate:
</span><span class='line'>*** CSRConnectionManager \n -stopScan
</span><span class='line'>** Gaia Connection(-discoveredPripheralDetails)
</span><span class='line'>*** CSRGaia \n -connectPeripheral:
</span><span class='line'>*** CSRGaiaManager \n -setDataEndPointMode:
</span><span class='line'>** BLE Disconnection
</span><span class='line'>*** CSRConnectionManager \n -removeDelegate: \n disconnectPeripheral
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p><strong>Error Domain=NSOSStatusErrorDomain Code=1954115647 &ldquo;(null)&rdquo;</strong>：音频数据不完整导致初始化音频播放器出错。</p>

<h2>2019.09.18</h2>

<p>Gaia VA</p>

<h3>封装、解析 Gaia 数据包  Done</h3>

<p><code>CSRGaiaGattCommand</code><br/>
  <code>- initWithLength:</code><br/>
  <code>- initWithNSData:</code></p>

<p>封装 command + vendor_id + data：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSData *)gaiaPacketWithCommand:(GaiaCommandType)command
</span><span class='line'>                           vendor:(uint16_t)vendor_id
</span><span class='line'>                             data:(NSData *)params{
</span><span class='line'>  CSRGaiaGattCommand *cmd = [[CSRGaiaGattCommand alloc] initWithLength:GAIA_GATT_HEADER_SIZE];        
</span><span class='line'>  if (cmd) {
</span><span class='line'>    [cmd setCommandId:command];
</span><span class='line'>    [cmd setVendorId:vendor_id];
</span><span class='line'>
</span><span class='line'>    if (params) {
</span><span class='line'>      [cmd addPayload:params];
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    NSData *packet = [cmd getPacket];
</span><span class='line'>
</span><span class='line'>    DLog(@"Outgoing packet: %@", packet);
</span><span class='line'>    return packet;
</span><span class='line'>  }
</span><span class='line'>  return nil;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (CSRGaiaGattCommand *)gaiaGattCommandWithGaiaPacket:(NSData *)packet{
</span><span class='line'>  return [[CSRGaiaGattCommand alloc] initWithNSData: packet];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (NSData *)payloadWithGaiaGattCommand:(CSRGaiaGattCommand *)command{
</span><span class='line'>  //  command type
</span><span class='line'>  GaiaCommandType cmdType = [command getCommandId];
</span><span class='line'>  //  payload
</span><span class='line'>  NSData *payload = [command getPayload];
</span><span class='line'>  return payload;
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>接收 Gaia 数据包  Done</h3>

<p><code>CSRGaiaManager</code>
  <code>CSRUpdateManagerDelegate</code>
    <code>- didReceiveGaiaGattResponse:</code><br/>
目前在<code>WWTicPodBTManager</code>中有监听。</p>

<h3>发送 Gaia 数据包  Todo</h3>

<p><code>CSRGaiaManager</code>
  <code>- getBattery</code>
    <code>CSRGaia</code>
      <code>- getBattery</code>
        <code>- sendCommand:vendor:data:</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)getBattery {    
</span><span class='line'>    [self sendCommand:GaiaCommand_GetCurrentBatteryLevel
</span><span class='line'>               vendor:CSR_GAIA_VENDOR_ID
</span><span class='line'>                 data:nil];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)setVolume:(NSInteger)value {
</span><span class='line'>    NSMutableData *payload = [[NSMutableData alloc] init];
</span><span class='line'>    uint8_t payload_event = (uint8_t)value;
</span><span class='line'>
</span><span class='line'>    [payload appendBytes:&payload_event length:1];
</span><span class='line'>    [self sendCommand:GaiaCommand_Volume
</span><span class='line'>               vendor:CSR_GAIA_VENDOR_ID
</span><span class='line'>                 data:payload];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Todo：<br/>
1、在 <code>CSRGaiaManager</code> 中添加 VA 相关命令；<br/>
2、在 <code>CSRGaia</code> 中添加 VA 相关命令；</p>

<h3>VA 状态管理  Todo</h3>

<p>消息确认，发送、接收、解析等。</p>

<h2>2019.09.19</h2>

<p>测定 BLE 传输 速率；</p>

<h2>2019.09.23</h2>

<p>运行时间</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CFAbsoluteTime startTime =CFAbsoluteTimeGetCurrent();
</span><span class='line'>
</span><span class='line'>//在这写入要计算时间的代码
</span><span class='line'>
</span><span class='line'>CFAbsoluteTime linkTime = (CFAbsoluteTimeGetCurrent() - startTime);
</span><span class='line'>
</span><span class='line'>NSLog(@"Linked in %f ms", linkTime *1000.0);</span></code></pre></td></tr></table></div></figure>


<p>音频解码是连续的，解码过程中初始化条件不能被重置。</p>

<h2>2019.09.24</h2>

<p>Voice Assistant State</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@startuml
</span><span class='line'>[*] --&gt; VA.CheckVersion
</span><span class='line'>
</span><span class='line'>VA.CheckVersion --&gt; VA.Idle : GaiaCheckVersion
</span><span class='line'>
</span><span class='line'>VA.Idle --&gt; VA.VoiceRequesting : GaiaStart
</span><span class='line'>VA.Idle -left-&gt; VA.MobvoiPaused : GaiaMobvoiPaused
</span><span class='line'>VA.Idle -right-&gt; VA.Idle : GaiaMobvoiFeatureEvent
</span><span class='line'>
</span><span class='line'>VA.MobvoiPaused --&gt; VA.Idle : GaiaMobvoiResumed
</span><span class='line'>
</span><span class='line'>state VA.Idle {
</span><span class='line'>  [*] --&gt; VA.Session.Normal
</span><span class='line'>  [*] --&gt; VA.Session.PushToTalk
</span><span class='line'>  [*] --&gt; VA.Session.Secretary
</span><span class='line'>  [*] --&gt; VA.Session.Joke
</span><span class='line'>
</span><span class='line'>  VA.Session.Normal : normal voice query, auto finish
</span><span class='line'>  VA.Session.PushToTalk : longpress voice query, ticpods finish
</span><span class='line'>  VA.Session.Secretary : voice query with special params
</span><span class='line'>  VA.Session.Joke : text query joke
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>VA.VoiceRequesting --&gt; VA.VoiceRequested : GaiaVoiceData
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested --&gt; VA.VoiceRequested : GaiaVoiceDataRequest ack
</span><span class='line'>VA.VoiceRequested --&gt; VA.VoiceRequested : GaiaVoiceData
</span><span class='line'>VA.VoiceRequested --&gt; VA.Idle : GaiaVoiceEnd
</span><span class='line'>VA.VoiceRequested --&gt; VA.Idle : GaiaCancel
</span><span class='line'>VA.VoiceRequested --&gt; VA.HostCancelOrEnd : GaiaMobvoiHostVoiceEnd
</span><span class='line'>VA.VoiceRequested --&gt; VA.HostCancelOrEnd : GaiaMobvoiHostCancel
</span><span class='line'>
</span><span class='line'>VA.HostCancelOrEnd --&gt; VA.Idle : GaiaVoiceEnd ack
</span><span class='line'>VA.HostCancelOrEnd --&gt; VA.Idle : GaiaCancel ack
</span><span class='line'>VA.HostCancelOrEnd --&gt; VA.Idle : GaiaStart
</span><span class='line'>
</span><span class='line'>VA.CheckVersion : GaiaCheckVersion:
</span><span class='line'>VA.CheckVersion : 1. ack GaiaCheckVersion
</span><span class='line'>VA.CheckVersion : 2. check protocol version
</span><span class='line'>VA.CheckVersion : 3. get G722 decoder parameters
</span><span class='line'>VA.CheckVersion : 4. initialize G722 decoder with parameters
</span><span class='line'>
</span><span class='line'>VA.Idle : GaiaStart:
</span><span class='line'>VA.Idle : 1. ack GaiaStart
</span><span class='line'>VA.Idle : 2. get session type\n
</span><span class='line'>
</span><span class='line'>VA.Idle : GaiaMobvoiPaused:
</span><span class='line'>VA.Idle : 1. no GaiaMobvoiPaused ack
</span><span class='line'>VA.Idle : 2. no GaiaMobvoiFeatureEvent ack\n
</span><span class='line'>
</span><span class='line'>VA.Idle : GaiaMobvoiFeatureEvent:
</span><span class='line'>VA.Idle : 1. no GaiaMobvoiFeatureEvent ack
</span><span class='line'>VA.Idle : 2. do special action
</span><span class='line'>
</span><span class='line'>VA.MobvoiPaused : GaiaMobvoiResumed:
</span><span class='line'>VA.MobvoiPaused : 1. no GaiaMobvoiResumed ack
</span><span class='line'>VA.MobvoiPaused : 2. ignore voice assistant command
</span><span class='line'>
</span><span class='line'>VA.VoiceRequesting : GaiaVoiceData:
</span><span class='line'>VA.VoiceRequesting : 1. no GaiaVoiceData ack
</span><span class='line'>VA.VoiceRequesting : 2. send GaiaVoiceDataRequest
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested : GaiaVoiceDataRequest ack:
</span><span class='line'>VA.VoiceRequested : 1. do nothing\n
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested : GaiaData:
</span><span class='line'>VA.VoiceRequested : 1. no GaiaData ack
</span><span class='line'>VA.VoiceRequested : 2. decode G722 packet
</span><span class='line'>VA.VoiceRequested : 3. send decoded voice data to speech sdk\n
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested : GaiaVoiceEnd:
</span><span class='line'>VA.VoiceRequested : 1. ack GaiaVoiceEnd
</span><span class='line'>VA.VoiceRequested : 2. finish recognition\n
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested : GaiaCancel:
</span><span class='line'>VA.VoiceRequested : 1. ack GaiaCancel
</span><span class='line'>VA.VoiceRequested : 2. cancel recognition\n
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested : GaiaMobvoiHostVoiceEnd:
</span><span class='line'>VA.VoiceRequested : 1. send GaiaVoiceEnd
</span><span class='line'>VA.VoiceRequested : 2. finish recognition\n
</span><span class='line'>
</span><span class='line'>VA.VoiceRequested : GaiaMobvoiHostCancel:
</span><span class='line'>VA.VoiceRequested : 1. send GaiaCancel
</span><span class='line'>VA.VoiceRequested : 2. cancel recognition
</span><span class='line'>
</span><span class='line'>VA.HostCancelOrEnd : GaiaVoiceEnd ack:
</span><span class='line'>VA.HostCancelOrEnd : 1. do nothing\n
</span><span class='line'>
</span><span class='line'>VA.HostCancelOrEnd : GaiaCancel ack:
</span><span class='line'>VA.HostCancelOrEnd : 1. do nothing\n
</span><span class='line'>
</span><span class='line'>VA.HostCancelOrEnd : GaiaStart:
</span><span class='line'>VA.HostCancelOrEnd : 1. VA.Idle -&gt; VA.VoiceRequesting
</span><span class='line'>@enduml</span></code></pre></td></tr></table></div></figure>


<p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201909/'>http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201909/</a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'>http://sxgfxm.github.io</a>
  </p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/zhi-shi-xiao-ji-201908/">知识小集-201908</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:47:39+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:47 am</span></time>
        
           | <a href="/blog/2020/01/17/zhi-shi-xiao-ji-201908/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/zhi-shi-xiao-ji-201908/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.08.06</h2>

<p><code>RPC failed; curl 56 LibreSSL SSL_read: SSL_ERROR_SYSCALL, errno 60</code>：拉取大文件时换成不够出错。<br/>
增大缓存空间：<code>git config https.postBuffer 524288000</code>，<code>git config http.postBuffer 524288000</code>。</p>

<h2>2019.08.07</h2>

<h3>SpeechSDK</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@startwbs
</span><span class='line'>* SpeechSDK
</span><span class='line'>** Buf
</span><span class='line'>*** set address
</span><span class='line'>*** get address
</span><span class='line'>*** set size
</span><span class='line'>*** get size
</span><span class='line'>** CallBackBase
</span><span class='line'>*** call back with parameter
</span><span class='line'>** Value
</span><span class='line'>** SpeechSDS
</span><span class='line'>*** make instance
</span><span class='line'>*** set parameter
</span><span class='line'>*** get parameter
</span><span class='line'>*** get service
</span><span class='line'>*** release service
</span><span class='line'>*** clear up
</span><span class='line'>*** destroy instance
</span><span class='line'>** Service
</span><span class='line'>*** invoke parameter
</span><span class='line'>** Parameter
</span><span class='line'>*** set parameter
</span><span class='line'>*** get parameter
</span><span class='line'>*** has parameter
</span><span class='line'>*** drop parameter
</span><span class='line'>*** clear parameter
</span><span class='line'>@endwbs</span></code></pre></td></tr></table></div></figure>


<h3>Speech Development Service</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@startwbs
</span><span class='line'>* Speech Development Service
</span><span class='line'>** Hotword Service
</span><span class='line'>*** SDS get Hotword service
</span><span class='line'>*** invoke Hotword parameter
</span><span class='line'>*** invoke start parameter
</span><span class='line'>*** start recorder
</span><span class='line'>*** invoke audio buf parameter
</span><span class='line'>*** process Hotword call back
</span><span class='line'>*** stop audio recorder
</span><span class='line'>*** invoke stop parameter
</span><span class='line'>*** SDS release Hotword service
</span><span class='line'>*** SDS destroy SDS
</span><span class='line'>** ASR Service
</span><span class='line'>*** sds get ASR service
</span><span class='line'>*** invoke ASR parameter
</span><span class='line'>*** invoke start parameter
</span><span class='line'>*** start recorder
</span><span class='line'>*** invoke audio buf parameter
</span><span class='line'>*** process ASR call back
</span><span class='line'>*** stop audio recorder
</span><span class='line'>*** invoke stop parameter
</span><span class='line'>*** SDS release ASR service
</span><span class='line'>*** SDS destroy SDS
</span><span class='line'>** TTS Service
</span><span class='line'>*** sds get TTS service
</span><span class='line'>*** invoke TTS parameter
</span><span class='line'>*** invoke start parameter
</span><span class='line'>*** invoke text parameter
</span><span class='line'>*** invok read parameter
</span><span class='line'>*** append audio data and play
</span><span class='line'>*** stop audio player
</span><span class='line'>*** invoke stop parameter
</span><span class='line'>*** SDS release TTS service
</span><span class='line'>*** SDS destroy SDS
</span><span class='line'>@endwbs</span></code></pre></td></tr></table></div></figure>


<h3>AssistantEngin</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@startwbs
</span><span class='line'>* AssitantEngine
</span><span class='line'>** Hotword
</span><span class='line'>*** load Hotword model
</span><span class='line'>*** start Hotword
</span><span class='line'>*** stop Hotword
</span><span class='line'>** ASR
</span><span class='line'>*** start ASR
</span><span class='line'>**** manual
</span><span class='line'>**** auto
</span><span class='line'>*** cancel ASR
</span><span class='line'>*** stop ASR
</span><span class='line'>** Text Query
</span><span class='line'>** TTS
</span><span class='line'>*** start TTS
</span><span class='line'>**** text
</span><span class='line'>**** type
</span><span class='line'>**** url
</span><span class='line'>*** stop TTS
</span><span class='line'>@endwbs</span></code></pre></td></tr></table></div></figure>


<h2>2019.08.15</h2>

<p><a href="http://www.mengyueping.com/2018/08/16/iOS_CocoaPods_03/">pod 私有库问题</a><br/>
<a href="http://adolsai.com/index.php/archives/cocoapods-private-error-list.html">pod 私有库问题</a><br/>
通过 <code>subspec</code> 实现目录结构分级；</p>

<p><strong>无法找到引用的第三方库</strong>：framework search path 有问题，设置<code>pod_target_xcconfig</code>时导致的。</p>

<p><strong>Undefined symbols for architecture arm64</strong>：在配置中增加 other linker flags。</p>

<p><strong>dyld: Library not loaded: @rpath</strong>：pod文件名与依赖库的名字相同，导致异常，更换pod名称。</p>

<p><strong>dynamic: Dynamic frameworks and libraries are only supported on iOS 8.0 and onwards</strong>：platform = :ios, &lsquo;9.0&rsquo;</p>

<p><strong>vendored framework not found</strong>：<a href="https://github.com/CocoaPods/CocoaPods/issues/1824">https://github.com/CocoaPods/CocoaPods/issues/1824</a> 改用'POD/file.h'</p>

<p><strong>Cocoapods wrapping around a static library without i386 architecture</strong>：s.pod_target_xcconfig = { &lsquo;VALID_ARCHS[sdk=iphonesimulator*]&rsquo; => &lsquo;&rsquo; }</p>

<p>source 中不要添加tag</p>

<h2>2019.08.20</h2>

<p>注意线程问题。</p>

<p><strong>HFP 状态下 AudioQueueNewOutput 无法正常播放音频</strong> 改为 A2DP 播放音频；  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/zhi-shi-xiao-ji-201908/'><a href="http://sxgfxm.github.io/blog/2020/01/17/zhi-shi-xiao-ji-201908/">http://sxgfxm.github.io/blog/2020/01/17/zhi-shi-xiao-ji-201908/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201907/">iOS知识小集-201907</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:41:32+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:41 am</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201907/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201907/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.07.01</h2>

<p>一般情况下，APP退到后台 30秒 后会被挂起。<br/>
申请后台任务，可以有至多 3分钟 时间处理任务，之后会被挂起。<br/>
由APP 触发timer 改为 蓝牙设备定期触发 timer，唤醒APP，执行操作。</p>

<h2>2019.07.02</h2>

<p>颈部操后台操作采用同样的逻辑。</p>

<h2>2019.07.05</h2>

<p>颈部操音乐处理，改为耳机状态下mix &amp; duck。<br/>
结束后需要setActive = NO。恢复其他音乐正常播放。</p>

<h2>2019.07.10</h2>

<p>监听<code>AVAudioSessionInterruptionNotification</code>获取打断开始和结束的通知，做相应的处理。</p>

<p>pod update <code>error: RPC failed; curl 56 LibreSSL SSL_read: SSL_ERROR_SYSCALL, errno 60</code>，
增加buffer大小，<code>git config --global http.postBuffer 114288000</code></p>

<h2>2019.07.11</h2>

<p><code>#import 'file'</code>，预处理后会递归复制头文件至当前文件；<br/>
<code>@import Module</code>，优化文件体积和编译速度；<br/>
<code>[[UIApplication sharedApplication] setIdleTimerDisabled:YES];</code>，防止灭屏；<br/>
<code>gem sources -l</code>，查看ruby gem镜像地址；<br/>
<code>gem source -r url</code>，删除ruby镜像地址；<br/>
<code>gem source -a url</code>，添加ruby镜像地址；</p>

<h2>2019.07.12</h2>

<p>检索特定字符串<br/>
1. 在工程目录下，<code>grep -r string .</code>；<br/>
2. 在ipa包内，<code>strings - -a -arch armv7 "AppName" | grep string</code>，<code>strings - -a -arch armv7 "AppName" &gt; AppName.txt</code>；</p>

<p>企业版打包，普通Team member只能安装developer版本，需要由管理员导出企业证书并安装，才可以导出distribution版本。</p>

<h2>2019.07.23</h2>

<p>无耳机条件下，A2DP不能少。<br/>
setActive:NO 可以恢复其他APP音乐。<br/>
开启 background task 来执行后台操作。</p>

<h2>2019.07.24</h2>

<p>Invalid virtual filesystem overlay file，clean，删除diriveddata，重启xcode。</p>

<p>制作git patch：<code>git format-patch commitID</code><br/>
应用git patch：<code>git am patchName</code><br/>
查看修改：<code>git apply patchName --reject</code><br/>
对照修改解决问题删除rej文件之后：<code>git add .</code> <code>git am --continue</code></p>

<h2>2019.07.29</h2>

<h3>Core Bluetooth</h3>

<p>Devices that implement the central role in Bluetooth low energy communication perform a number of common tasks—for example,<br/>
<strong>discovering and connecting to available peripherals, and exploring and interacting with the data that peripherals have to offer. </strong>
Devices that implement the peripheral role also perform a number of common, but different, tasks—for example,<br/>
<strong>publishing and advertising services, and responding to read, write, and subscription requests from connected centrals.</strong></p>

<p>A peripheral typically has data that is needed by other devices.<br/>
A central typically uses the information served up by a peripheral to accomplish some task.</p>

<p>Peripherals make their presence known by advertising the data(services、characteristics) they have over the air.<br/>
Centrals scan for nearby peripherals that might have data they’re interested in, or interact with a peripheral’s service by reading or writing the value of that service’s characteristic.</p>

<p>When a central discovers such a peripheral,
the central requests to connect to the peripheral and begins exploring and interacting with the peripheral’s data.<br/>
The peripheral is responsible for responding to the central in appropriate ways.<br/>
You can retrieve the value of a characteristic by reading it directly or by subscribing to it.</p>

<h4>As Centrals</h4>

<p><code>CBCentralManager</code></p>

<p><code>CBPeripheral</code><br/>
    <code>CBService</code><br/>
        <code>CBCharacteristic</code>
        <code>CBCharacteristic</code>
    <code>CBService</code><br/>
        <code>CBCharacteristic</code>
        <code>CBCharacteristic</code></p>

<h4>As Peripherals</h4>

<p><code>CBPeripheralManager</code></p>

<p><code>CBMutableService</code>
    <code>CBMutableCharacteristic</code>
    <code>CBMutableCharacteristic </code></p>

<p><code>CBCentral</code></p>

<h4>Centrals</h4>

<p>Start up a central manager object</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">myCentralManager</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBCentralManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDelegate</span><span class="p">:</span><span class="nb">self</span> <span class="nl">queue</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Discover and connect to peripheral devices that are advertising</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">//  specify services CBUUID to discover peripherials you are interested in</span>
</span><span class='line'><span class="p">[</span><span class="n">myCentralManager</span> <span class="nl">scanForPeripheralsWithServices</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">centralManager:</span><span class="p">(</span><span class="bp">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">central</span>
</span><span class='line'> <span class="nf">didDiscoverPeripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'>     <span class="nf">advertisementData:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">advertisementData</span>
</span><span class='line'>                  <span class="nf">RSSI:</span><span class="p">(</span><span class="bp">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="nv">RSSI</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//  If you plan to connect to the discovered peripheral, keep a strong reference to it so the system does not deallocate it.</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Discovered %@&quot;</span><span class="p">,</span> <span class="n">peripheral</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">discoveredPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  save power</span>
</span><span class='line'><span class="p">[</span><span class="n">myCentralManager</span> <span class="n">stopScan</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Connecting to a Peripheral Device After You’ve Discovered It</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="n">myCentralManager</span> <span class="nl">connectPeripheral</span><span class="p">:</span><span class="n">peripheral</span> <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">centralManager:</span><span class="p">(</span><span class="bp">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">central</span>
</span><span class='line'>  <span class="nf">didConnectPeripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Peripheral connected&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  set peripheral delegate</span>
</span><span class='line'>    <span class="n">peripheral</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  specify services CBUUID to discover services you are interested in</span>
</span><span class='line'>    <span class="p">[</span><span class="n">peripheral</span> <span class="nl">discoverServices</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Discovering the Services of a Peripheral That You’re Connected To</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'><span class="nf">didDiscoverServices:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="bp">CBService</span> <span class="o">*</span><span class="n">service</span> <span class="k">in</span> <span class="n">peripheral</span><span class="p">.</span><span class="n">services</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Discovered service %@&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Discovering characteristics for service %@&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
</span><span class='line'>        <span class="p">[</span><span class="n">peripheral</span> <span class="nl">discoverCharacteristics</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">forService</span><span class="p">:</span><span class="n">service</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Discovering the Characteristics of a Service</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'><span class="nf">didDiscoverCharacteristicsForService:</span><span class="p">(</span><span class="bp">CBService</span> <span class="o">*</span><span class="p">)</span><span class="nv">service</span>
</span><span class='line'>             <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="bp">CBCharacteristic</span> <span class="o">*</span><span class="n">characteristic</span> <span class="k">in</span> <span class="n">service</span><span class="p">.</span><span class="n">characteristics</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Discovered characteristic %@&quot;</span><span class="p">,</span> <span class="n">characteristic</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  read characteristic</span>
</span><span class='line'>        <span class="p">[</span><span class="n">peripheral</span> <span class="nl">readValueForCharacteristic</span><span class="p">:</span><span class="n">characteristic</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  subscribe characteristic</span>
</span><span class='line'>        <span class="p">[</span><span class="n">peripheral</span> <span class="nl">setNotifyValue</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">forCharacteristic</span><span class="p">:</span><span class="n">interestingCharacteristic</span><span class="p">];</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Retrieving the Value of a Characteristic</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'><span class="nf">didUpdateValueForCharacteristic:</span><span class="p">(</span><span class="bp">CBCharacteristic</span> <span class="o">*</span><span class="p">)</span><span class="nv">characteristic</span>
</span><span class='line'>             <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">characteristic</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// parse the data as needed</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'><span class="nf">didUpdateNotificationStateForCharacteristic:</span><span class="p">(</span><span class="bp">CBCharacteristic</span> <span class="o">*</span><span class="p">)</span><span class="nv">characteristic</span>
</span><span class='line'>             <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error changing notification state: %@&quot;</span><span class="p">,</span>
</span><span class='line'>           <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Writing the Value of a Characteristic</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Writing value for characteristic %@&quot;</span><span class="p">,</span> <span class="n">interestingCharacteristic</span><span class="p">);</span>
</span><span class='line'><span class="p">[</span><span class="n">peripheral</span> <span class="nl">writeValue</span><span class="p">:</span><span class="n">dataToWrite</span> <span class="nl">forCharacteristic</span><span class="p">:</span><span class="n">interestingCharacteristic</span> <span class="nl">type</span><span class="p">:</span><span class="n">CBCharacteristicWriteWithResponse</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheral:</span><span class="p">(</span><span class="bp">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'><span class="nf">didWriteValueForCharacteristic:</span><span class="p">(</span><span class="bp">CBCharacteristic</span> <span class="o">*</span><span class="p">)</span><span class="nv">characteristic</span>
</span><span class='line'>             <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error writing characteristic value: %@&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Peripherals</h4>

<p>Starting Up a Peripheral Manager</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">myPeripheralManager</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBPeripheralManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDelegate</span><span class="p">:</span><span class="nb">self</span> <span class="nl">queue</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Setting Up Your Services and Characteristics</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">//  value != nil 只可读，value == nil 可写</span>
</span><span class='line'><span class="n">myCharacteristic</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBMutableCharacteristic</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithType</span><span class="p">:</span><span class="n">myCharacteristicUUID</span>
</span><span class='line'>                                                      <span class="nl">properties</span><span class="p">:</span><span class="n">CBCharacteristicPropertyRead</span>
</span><span class='line'>                                                           <span class="nl">value</span><span class="p">:</span><span class="n">myValue</span>
</span><span class='line'>                                                     <span class="nl">permissions</span><span class="p">:</span><span class="n">CBAttributePermissionsReadable</span><span class="p">];</span>
</span><span class='line'><span class="c1">//  primary service &amp;&amp; secondary service</span>
</span><span class='line'><span class="n">myService</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBMutableService</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithType</span><span class="p">:</span><span class="n">myServiceUUID</span> <span class="nl">primary</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  add characteristics</span>
</span><span class='line'><span class="n">myService</span><span class="p">.</span><span class="n">characteristics</span> <span class="o">=</span> <span class="l">@[</span><span class="n">myCharacteristic</span><span class="l">]</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Publishing Your Services and Characteristics</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">//  add service</span>
</span><span class='line'><span class="p">[</span><span class="n">myPeripheralManager</span> <span class="nl">addService</span><span class="p">:</span><span class="n">myService</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheralManager:</span><span class="p">(</span><span class="bp">CBPeripheralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'>            <span class="nf">didAddService:</span><span class="p">(</span><span class="bp">CBService</span> <span class="o">*</span><span class="p">)</span><span class="nv">service</span>
</span><span class='line'>                    <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error publishing service: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Advertising Your Services</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="n">myPeripheralManager</span> <span class="nl">startAdvertising</span><span class="p">:</span><span class="l">@{</span> <span class="nl">CBAdvertisementDataServiceUUIDsKey</span> <span class="p">:</span> <span class="l">@[</span><span class="n">myFirstService</span><span class="p">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">mySecondService</span><span class="p">.</span><span class="n">UUID</span><span class="l">]</span> <span class="l">}</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheralManagerDidStartAdvertising:</span><span class="p">(</span><span class="bp">CBPeripheralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span>
</span><span class='line'>                                       <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error advertising: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Responding to Read and Write Requests from a Central</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheralManager:</span><span class="p">(</span><span class="bp">CBPeripheralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span> <span class="nf">didReceiveReadRequest:</span><span class="p">(</span><span class="bp">CBATTRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">request</span><span class="p">.</span><span class="n">characteristic</span><span class="p">.</span><span class="n">UUID</span> <span class="nl">isEqual</span><span class="p">:</span><span class="n">myCharacteristic</span><span class="p">.</span><span class="n">UUID</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">myCharacteristic</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">myPeripheralManager</span> <span class="nl">respondToRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>                <span class="nl">withResult</span><span class="p">:</span><span class="n">CBATTErrorInvalidOffset</span><span class="p">];</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">request</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">myCharacteristic</span><span class="p">.</span><span class="n">value</span> <span class="nl">subdataWithRange</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">myCharacteristic</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">request</span><span class="p">.</span><span class="n">offset</span><span class="p">)];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">myPeripheralManager</span> <span class="nl">respondToRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">withResult</span><span class="p">:</span><span class="n">CBATTErrorSuccess</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheralManager:</span><span class="p">(</span><span class="bp">CBPeripheralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span> <span class="nf">didReceiveWriteRequests:</span><span class="p">(</span><span class="bp">NSArray</span><span class="o">&lt;</span><span class="bp">CBATTRequest</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">requests</span><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">request</span><span class="p">.</span><span class="n">characteristic</span><span class="p">.</span><span class="n">UUID</span> <span class="nl">isEqual</span><span class="p">:</span><span class="n">myCharacteristic</span><span class="p">.</span><span class="n">UUID</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">myCharacteristic</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">myPeripheralManager</span> <span class="nl">respondToRequest</span><span class="p">:[</span><span class="n">requests</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="nl">withResult</span><span class="p">:</span><span class="n">CBATTErrorSuccess</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sending Updated Characteristic Values to Subscribed Centrals</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripheralManager:</span><span class="p">(</span><span class="bp">CBPeripheralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span> <span class="nf">central:</span><span class="p">(</span><span class="bp">CBCentral</span> <span class="o">*</span><span class="p">)</span><span class="nv">central</span> <span class="nf">didSubscribeToCharacteristic:</span><span class="p">(</span><span class="bp">CBCharacteristic</span> <span class="o">*</span><span class="p">)</span><span class="nv">characteristic</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Central subscribed to characteristic %@&quot;</span><span class="p">,</span> <span class="n">characteristic</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSData</span> <span class="o">*</span><span class="n">updatedValue</span> <span class="o">=</span> <span class="c1">// fetch the characteristic&#39;s new value</span>
</span><span class='line'>    <span class="kt">BOOL</span> <span class="n">didSendValue</span> <span class="o">=</span> <span class="p">[</span><span class="n">myPeripheralManager</span> <span class="nl">updateValue</span><span class="p">:</span><span class="n">updatedValue</span> <span class="nl">forCharacteristic</span><span class="p">:</span><span class="n">characteristic</span> <span class="nl">onSubscribedCentrals</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">peripherialManagerIsReadyToUpdateSubscribers:</span><span class="p">(</span><span class="bp">CBPeripheralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">peripheral</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Background Processing</h4>

<p>That said, you can declare your app to support the Core Bluetooth background execution modes to allow your app to be woken up from a suspended state to process certain Bluetooth-related events. Even if your app doesn’t need the full range of background processing support, it can still ask to be alerted by the system when important events occur.</p>

<p>All Bluetooth-related events that occur while a foreground-only app is in the suspended state are queued by the system and delivered to the app only when it resumes to the foreground. That said, Core Bluetooth provides a way to alert the user when certain central role events occur. The user can then use these alerts to decide whether a particular event warrants bringing the app back to the foreground.</p>

<p><code>CBConnectPeripheralOptionNotifyOnConnectionKey</code><br/>
<code>CBConnectPeripheralOptionNotifyOnDisconnectionKey</code>
<code>CBConnectPeripheralOptionNotifyOnNotificationKey </code></p>

<p><code>bluetooth-central</code><br/>
<code>bluetooth-peripheral</code> <br/>
While your app is in the background you can still discover and connect to peripherals, and explore and interact with peripheral data. In addition, the system wakes up your app when any of the CBCentralManagerDelegate or CBPeripheralDelegate delegate methods are invoked, allowing your app to handle important central role events, such as when a connection is established or torn down, when a peripheral sends updated characteristic values, and when a central manager’s state changes.</p>

<p>Upon being woken up, an app has around <strong>10 seconds</strong> to complete a task. Ideally, it should complete the task as fast as possible and allow itself to be suspended again. Apps that spend too much time executing in the background can be throttled back by the system or killed.</p>

<p>Adding Support for State Preservation and Restoration</p>

<p>Opt In to State Preservation and Restoration</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">myCentralManager</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBCentralManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDelegate</span><span class="p">:</span><span class="nb">self</span>
</span><span class='line'>                                                        <span class="nl">queue</span><span class="p">:</span><span class="nb">nil</span>
</span><span class='line'>                                                      <span class="nl">options</span><span class="p">:</span><span class="l">@{</span> <span class="nl">CBCentralManagerOptionRestoreIdentifierKey</span><span class="p">:</span> <span class="s">@&quot;myCentralManagerIdentifier&quot;</span> <span class="l">}</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reinstantiate Your Central and Peripheral Managers</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="bp">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">centralManagerIdentifiers</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">launchOptions</span><span class="p">[</span><span class="n">UIApplicationLaunchOptionsBluetoothCentralsKey</span><span class="p">];</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Implement the Appropriate Restoration Delegate Method<br/>
Update Your Initialization Process</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">centralManager:</span><span class="p">(</span><span class="bp">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">central</span>
</span><span class='line'>      <span class="nf">willRestoreState:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">state</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">peripherals</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">state</span><span class="p">[</span><span class="n">CBCentralManagerRestoredStatePeripheralsKey</span><span class="p">];</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSUInteger</span> <span class="n">serviceUUIDIndex</span> <span class="o">=</span>
</span><span class='line'>        <span class="p">[</span><span class="n">peripheral</span><span class="p">.</span><span class="n">services</span> <span class="nl">indexOfObjectPassingTest</span><span class="p">:</span><span class="o">^</span><span class="kt">BOOL</span><span class="p">(</span><span class="bp">CBService</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
</span><span class='line'>        <span class="bp">NSUInteger</span> <span class="n">index</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">UUID</span> <span class="nl">isEqual</span><span class="p">:</span><span class="n">myServiceUUIDString</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">serviceUUIDIndex</span> <span class="o">==</span> <span class="n">NSNotFound</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">peripheral</span> <span class="nl">discoverServices</span><span class="p">:</span><span class="l">@[</span><span class="n">myServiceUUIDString</span><span class="l">]</span><span class="p">];</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Best Practices as Central</h4>

<p>Scan for Devices Only When You Need To
Unless you need to discover more devices, stop scanning for other devices after you have found one you want to connect to.</p>

<p>Explore a Peripheral’s Data Wisely
Therefore, you should look for and discover only the services and associated characteristics your app needs.</p>

<p>Subscribe to Characteristic Values That Change Often
It is best practice to subscribe to a characteristic’s value when possible, especially for characteristic values that change often.</p>

<p>Disconnect from a Device When You Have All the Data You Need</p>

<p>Reconnecting to Peripherals<br/>
Retrieving a List of Known Peripherals</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">knownPeripherals</span> <span class="o">=</span> <span class="p">[</span><span class="n">myCentralManager</span> <span class="nl">retrievePeripheralsWithIdentifiers</span><span class="p">:</span><span class="n">savedIdentifiers</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Retrieving a List of Connected Peripherals</p>

<h4>Best Practices as Peripheral</h4>

<p>Respect the Limits of Advertising Data
When your app is in the foreground, it can use up to <strong>28 bytes</strong> of space in the initial advertisement data for any combination of the two supported advertising data keys.</p>

<p>Configure Your Characteristics to Support Notifications</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">myCharacteristic</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBMutableCharacteristic</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithType</span><span class="p">:</span><span class="n">myCharacteristicUUID</span>
</span><span class='line'>                                                      <span class="nl">properties</span><span class="p">:</span><span class="n">CBCharacteristicPropertyRead</span> <span class="o">|</span> <span class="n">CBCharacteristicPropertyNotify</span>
</span><span class='line'>                                                           <span class="nl">value</span><span class="p">:</span><span class="nb">nil</span>
</span><span class='line'>                                                     <span class="nl">permissions</span><span class="p">:</span><span class="n">CBAttributePermissionsReadable</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Require a Paired Connection to Access Sensitive Data</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">emailCharacteristic</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">CBMutableCharacteristic</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithType</span><span class="p">:</span><span class="n">emailCharacteristicUUID</span>
</span><span class='line'>                                                         <span class="nl">properties</span><span class="p">:</span><span class="n">CBCharacteristicPropertyRead</span> <span class="o">|</span> <span class="n">CBCharacteristicPropertyNotifyEncryptionRequired</span>
</span><span class='line'>                                                              <span class="nl">value</span><span class="p">:</span><span class="nb">nil</span>
</span><span class='line'>                                                        <span class="nl">permissions</span><span class="p">:</span><span class="n">CBAttributePermissionsReadEncryptionRequired</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201907/'>http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201907/</a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'>http://sxgfxm.github.io</a>
  </p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201906/">iOS知识小集-201906</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:36:46+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:36 am</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201906/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201906/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.06.06</h2>

<h3>音频基础</h3>

<p><strong>音频文件</strong>：即声音的数字信号。由原声音信息采样、量化和编码产生。<br/>
<strong>奈奎塞特理论</strong>：采样频率高于声音最高频率的两倍时，才能将数字信号还原为原来的声音。一般为40~50kHZ。<br/>
<strong>脉冲编码调制</strong>：对声音进行采样、量化的过程，简称 <strong>PCM</strong>。PCM数据为原始音频数据，完全无损，体积庞大。<br/>
<strong>音频格式</strong>：无损压缩（ALAC、APE、FLAC），有损压缩（MP3、AAC、OGG、WMA）。<br/>
<strong>MP3码率</strong>：代表压缩质量，码率越高、质量越好。固定码率（CBR），可变码率（VBR）。<br/>
<strong>MP3数据结构</strong>：ID3 + 音频数据。音频数据由帧（帧头4B + 附加信息32B + 声音数据）构成。</p>

<h3>iOS音频播放</h3>

<p>只播放音频文件：AVFoudation。<br/>
播放并存储音频文件：AudioFileStreamer + AudioQueue。边下载音频数据边用NSFileHandler读取本地音频文件给AudioFileStreamer解析分离音频帧，之后给AudioQueue进行解码和播放。<br/>
专业音乐播放器：使用AudioConverter把音频数据转换为PCM数据，再由AudioUnit + AUGraph进行音效处理和播放。</p>

<h3>AudioSession</h3>

<h4>AudioSession作用：</h4>

<p>1、定义APP如何使用音频（是录音还是播放）；<br/>
2、选择音频输入输出设备（手机麦克风、手机扬声器、耳机麦克风、耳机扬声器）；<br/>
3、协调其他APP音频和系统音频（电话打断，是否混响）；</p>

<h4>AudioSession使用：</h4>

<p>1、设置category；<br/>
2、设置options；<br/>
3、setActive；</p>

<h3>AudioFileStream</h3>

<h4>AudioFileStream作用：</h4>

<p>1、读取采样率、码率、时长等基本信息；<br/>
2、分离音频帧；</p>

<h3>AudioQueue</h3>

<h4>AudioQueue作用：</h4>

<p>1、播放PCM数据、MP3数据；<br/>
2、录音；</p>

<h4>AudioQueue使用：</h4>

<p>1、创建AudioQueue；<br/>
2、创建AudioQueueBufferRef；<br/>
3、将数据写入AudioQueueBufferRef，然后插入到AudioQueue中；<br/>
4、调用AudioQueueStart开始播放；<br/>
5、在回调中将使用过的AudioQueueBufferRef放回重复使用；</p>

<h2>20919.06.11</h2>

<h4>AVAudioSessionCategoryOptionAllowBluetooth</h4>

<p>采用 HFP 协议将 <strong>蓝牙设备作为音频输入设备，且同时自动变为输出设备</strong>。通常使用蓝牙设备录音时使用，此协议下蓝牙设备既可录音又可播放音频，但 <strong>音质较差</strong>。<br/>
只在 category 为 AVAudioSessionCategoryPlayAndRecord、AVAudioSessionCategoryRecord 时使用。</p>

<h3>AVAudioSessionCategoryOptionAllowBluetoothA2DP</h3>

<p>采用 A2DP 协议将 <strong>蓝牙设备作为音频输出设备</strong>。通常用来作为高质量音频蓝牙输出，比如播放音乐，此协议下蓝牙设备 <strong>无法作为音频输入设备</strong>，音频输入需要使用手机麦克风。<br/>
category 为 AVAudioSessionCategoryAmbient、AVAudioSessionCategorySoloAmbient、AVAudioSessionCategoryPlayback 时，默认采用 A2DP。<br/>
category 为 AVAudioSessionCategoryPlayAndRecord 时，如果需要使用 A2DP，需显示设置。<br/>
category 为 AVAudioSessionCategoryMultiRoute、AVAudioSessionCategoryRecord 时，A2DP 默认无效。<br/>
AVAudioSessionCategoryOptionAllowBluetooth 和 AVAudioSessionCategoryOptionAllowBluetoothA2DP 同时设置时，优先采用前者。<br/>
使用原则：<br/>
1、播放音频时，为了保证音频输出质量，采用 AVAudioSessionCategoryOptionAllowBluetoothA2DP；<br/>
2、既需要录音又需要播放音频时，需采用 AVAudioSessionCategoryOptionAllowBluetooth；</p>

<h2>2019.06.12</h2>

<p>后台开启AVAudioSession需要设置为MixWithOthers，否则无法激活。</p>

<h2>2019.06.13</h2>

<p>Could not find a <code>ios</code> simulator。<br/>
<code>gem env</code> 找到ruby路径查看 <code>fourflusher</code> 中 的 <code>find.rb</code> 文件。</p>

<h2>2019.06.14</h2>

<p>打包机器company账号过期，需重新登录。<br/>
Error：<code>CodeSign /Users/Library/Developer/Xcode/DerivedData/Build/Intermediates.noindex/ArchiveIntermediates</code>。<br/>
解决办法：<br/>
    unlock keychain <code>security unlock-keychain -p mobvoi login.keychain</code>，<code>security set-key-partition-list -S apple: -s -k mobvoi login.keychain</code>；<br/>
    删除过期provisioningprofile。<code>~/Library/MobileDevice/Provisioning Profiles</code>；<br/>
    清除<code>~/Library/Developer/Xcode/DerivedData/</code>；<br/>
    修改证书信任。<br/>
参考资料：<br/>
    <a href="https://stackoverflow.com/questions/37806538/code-signing-is-required-for-product-type-application-in-sdk-ios-10-0-stic">Code signing is required for product type &lsquo;Application&rsquo; in SDK &lsquo;iOS 10.0&rsquo; </a><br/>
    <a href="https://github.com/fastlane/fastlane/issues/14040">code sign failed</a><br/>
    <a href="https://juejin.im/post/5c1074c8e51d451f751bc01e">Sh 打包报错</a></p>

<h2>2019.06.17</h2>

<p>打包机器无法拉取gerrit代码。<br/>
Error：<code>gerrit_jenkins@gerrit: Permission denied (publickey)</code>。</p>

<p><a href="https://help.github.com/en/articles/error-permission-denied-publickey">参考解决方法</a><br/>
生成秘钥：<code>ssh-keygen</code><br/>
查看秘钥：<code>cd ~/.ssh</code><br/>
查看公钥：<code>cat ~/.ssh/id_rsa.pub</code><br/>
查看私钥：<code>cat ~/.ssh/id_rsa</code><br/>
查看已发布公钥：<code>cat ~/.ssh/known_hosts</code></p>

<h2>2019.06.20</h2>

<p>PCM 转 WAV</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSData</span><span class="o">*</span><span class="p">)</span><span class="nf">stripAndAddWavHeader:</span><span class="p">(</span><span class="bp">NSData</span><span class="o">*</span><span class="p">)</span> <span class="nv">wav</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wavDataSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">wav</span> <span class="n">length</span><span class="p">]</span> <span class="o">-</span> <span class="mi">44</span><span class="p">;</span>
</span><span class='line'>  <span class="bp">NSData</span> <span class="o">*</span><span class="n">WaveFile</span><span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableData</span> <span class="nl">dataWithData</span><span class="p">:[</span><span class="n">wav</span> <span class="nl">subdataWithRange</span><span class="p">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="n">wavDataSize</span><span class="p">)]];</span>
</span><span class='line'>  <span class="bp">NSMutableData</span> <span class="o">*</span><span class="n">newWavData</span><span class="p">;</span>
</span><span class='line'>  <span class="n">newWavData</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">addWavHeader</span><span class="p">:</span><span class="n">WaveFile</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">newWavData</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMutableData</span> <span class="o">*</span><span class="p">)</span><span class="nf">addWavHeader:</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">wavNoheader</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">headerSize</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">totalAudioLen</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavNoheader</span> <span class="n">length</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">totalDataLen</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavNoheader</span> <span class="n">length</span><span class="p">]</span> <span class="o">+</span> <span class="n">headerSize</span><span class="o">-</span><span class="mi">8</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">longSampleRate</span> <span class="o">=</span> <span class="mf">8000.0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">byteRate</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mf">16000.0</span> <span class="o">*</span> <span class="n">channels</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Byte</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>  <span class="c1">// RIFF/WAVE header</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;I&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">(</span><span class="n">totalDataLen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">totalDataLen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">totalDataLen</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">totalDataLen</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;W&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;V&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">;</span>  <span class="c1">// &#39;fmt &#39; chunk</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;m&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>  <span class="c1">// 4 bytes: size of &#39;fmt &#39; chunk</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// format = 1</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="n">channels</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">(</span><span class="n">longSampleRate</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">longSampleRate</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">longSampleRate</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">longSampleRate</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">(</span><span class="n">byteRate</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">byteRate</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">byteRate</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">byteRate</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>  <span class="c1">// block align</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>  <span class="c1">// bits per sample</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">(</span><span class="n">totalAudioLen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">totalAudioLen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">totalAudioLen</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">header</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte</span><span class="p">)</span> <span class="p">((</span><span class="n">totalAudioLen</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">NSMutableData</span> <span class="o">*</span><span class="n">newWavData</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableData</span> <span class="nl">dataWithBytes</span><span class="p">:</span><span class="n">header</span> <span class="nl">length</span><span class="p">:</span><span class="mi">44</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">newWavData</span> <span class="nl">appendBytes</span><span class="p">:[</span><span class="n">wavNoheader</span> <span class="n">bytes</span><span class="p">]</span> <span class="nl">length</span><span class="p">:[</span><span class="n">wavNoheader</span> <span class="n">length</span><span class="p">]];</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">newWavData</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>multipart/form-data 上传 NSData<br/>
<a href="https://stackoverflow.com/questions/24250475/post-multipart-form-data-with-objective-c-swift">multipart/form-data upload</a></p>

<h2>2019.06.21</h2>

<p>NSFileManager、NSFileHandle</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">writeFile:</span><span class="p">(</span><span class="bp">NSData</span><span class="o">*</span><span class="p">)</span><span class="nv">data</span> <span class="nf">toPath:</span><span class="p">(</span><span class="bp">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">path</span><span class="p">{</span>
</span><span class='line'>  <span class="c1">//  创建文件</span>
</span><span class='line'>  <span class="bp">NSFileManager</span> <span class="o">*</span><span class="n">fileManager</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">fileManager</span> <span class="nl">removeItemAtPath</span><span class="p">:</span><span class="n">path</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">fileManager</span> <span class="nl">createFileAtPath</span><span class="p">:</span><span class="n">path</span> <span class="nl">contents</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">attributes</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">//  写入文件</span>
</span><span class='line'>  <span class="bp">NSFileHandle</span> <span class="o">*</span><span class="n">fileHandle</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSFileHandle</span> <span class="nl">fileHandleForWritingAtPath</span><span class="p">:</span><span class="n">path</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">fileHandle</span> <span class="nl">writeData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">fileHandle</span> <span class="n">closeFile</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>convert <code>CMSampleBufferRef</code> to <code>NSData</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSData</span><span class="o">*</span><span class="p">)</span><span class="nf">dataFrom:</span><span class="p">(</span><span class="n">CMSampleBufferRef</span><span class="p">)</span><span class="nv">sampleBuffer</span><span class="p">{</span>
</span><span class='line'>  <span class="n">CMBlockBufferRef</span> <span class="n">blockBufferRef</span> <span class="o">=</span> <span class="n">CMSampleBufferGetDataBuffer</span><span class="p">(</span><span class="n">sampleBuffer</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">size_t</span> <span class="n">length</span> <span class="o">=</span> <span class="n">CMBlockBufferGetDataLength</span><span class="p">(</span><span class="n">blockBufferRef</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Byte</span> <span class="n">buffer</span><span class="p">[</span><span class="n">length</span><span class="p">];</span>
</span><span class='line'>  <span class="n">CMBlockBufferCopyDataBytes</span><span class="p">(</span><span class="n">blockBufferRef</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span><span class='line'>  <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSData</span> <span class="nl">dataWithBytes</span><span class="p">:</span><span class="n">buffer</span> <span class="nl">length</span><span class="p">:</span><span class="n">length</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>PBXCp Error: No such file or directory</p>

<p><a href="https://forums.developer.apple.com/thread/12443#33677">bitcode_strip exited with 1</a><br/>
In additional to your answer, there is mush simpler method. As I see, XCode uses bitcode-strip only when enviroment variable STRIP_BITCODE_FROM_COPIED_FILES is set to YES. It seems that it&rsquo;s set to default when enable_bitcode is switched on.<br/>
Add User-Defined Setting STRIP_BITCODE_FROM_COPIED_FILES=NO to your Target and it will compile fine, XCode will use standard strip.</p>

<h2>2019.06.27</h2>

<p>however, it’s generally preferable to deactivate your audio session before changing the category or other session properties. Making these changes while the session is deactivated prevents unnecessary reconfigurations of the audio system.</p>

<p>Ensure that the audio session for an app using a recording category is active only while recording. Before recording starts and when it stops, ensure that your session is inactive to allow other sounds, such as incoming message alerts, to play.</p>

<p>If an app supports background audio playback or recording, deactivate its audio session when entering the background if the app is not actively using audio (or preparing to use audio). Doing so allows the system to free up audio resources so that they may be used by other processes. It also prevents the app&rsquo;s audio session from being deactivated when the app process is suspended by the operating system.</p>

<p>An audio interruption is the deactivation of your app’s audio session—which immediately stops your audio. Interruptions happen when a competing audio session from an app is activated and that session is not categorized by the system to mix with yours. After your session goes inactive, the system sends a “you were interrupted” message that you can respond to by saving state, updating the user interface, and so on.</p>

<h2>2019.06.28</h2>

<p>如何后台运行timer：通过蓝牙设备触发。  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201906/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201906/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201906/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201905/">iOS知识小集-201905</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:32:44+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:32 am</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201905/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201905/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.05.05</h2>

<p>Flutter 状态管理<br/>
Flutter的很多灵感来自于React，它的设计思想是数据与视图分离，由数据映射渲染视图。所以在Flutter中，它的Widget是immutable的，而它的动态部分全部放到了状态(State)中。<br/>
<a href="https://juejin.im/post/5b97fa0d5188255c5546dcf8">Scoped Model</a>
<a href="https://juejin.im/post/5ba26c086fb9a05ce57697da">Redux</a><br/>
<a href="https://juejin.im/post/5bb6f344f265da0aa664d68a">BLoC</a><br/>
<a href="https://medium.com/flutter-community/why-use-rxdart-and-how-we-can-use-with-bloc-pattern-in-flutter-a64ca2c7c52d">BLoC</a></p>

<h2>2019.05.06</h2>

<p><a href="https://medium.com/flutter-community/widget-state-buildcontext-inheritedwidget-898d671b7956">Widget - State - BuildContext - InheritedWidget</a></p>

<ol>
<li>Widgets: related to layout;</li>
<li>Widgets Tree: widgets are organized in tree structures;</li>
<li>BuildContext: a reference to the location of a widget with in the widgets tree. a BuildContext only belongs to one widget.</li>
<li>Stateless Widget: 创建之后就无法再改变的控件，比如Text，Row，Container，不会rebuild；</li>
<li>Stateful Widget: 创建之后可以根据状态发生变化；widget.color；</li>
<li>State: 状态的改变会影响控件的行为和布局，触发rebuild；State会和BuildContext绑定，绑定之后称为mounted，只有mounted之后，才可以setState；State mounted之后，不能直接被其他BuildContext访问；</li>
<li>Stateful Widget Life Circle: constructor() -> createState() -> constructor() -> initState(){ controllers, animations, &hellip; } -> mounted -> didChangeDependencies(){ listeners } -> build() { build widgets } -> dispose() { controllers, listeners, &hellip;} ；</li>
<li>在 widget 的生命周期中，是否需要根据变量的变化来 rebuild widget；</li>
<li>Widget unique identity - key：widgets的唯一标识，可以通过key来获取widget；</li>
<li>State -> BuildContext -> Widget Instance：通过key来访问 state；</li>
<li>InheritedWidget：实现在widget tree中高效O(1)共享信息；</li>
</ol>


<p><a href="https://medium.com/flutter-community/reactive-programming-streams-bloc-6f0d2bd2d248">Reactive Programming - Streams - BLoC</a></p>

<ol>
<li><strong>BlocBase</strong></li>
<li><strong>BlocProvider </strong></li>
<li><strong>ApplicationBloc </strong></li>
<li><strong>LoginBloc </strong></li>
<li>RxDart</li>
</ol>


<p>dependencies:<br/>
  bloc:^0.8.0<br/>
  flutter_bloc:^0.5.0<br/>
  equatable:^0.1.6</p>

<h2>2019.05.07</h2>

<p><a href="https://felangel.github.io/bloc/#/">bloc</a></p>

<h2>2019.05.13</h2>

<p>构造方法：<br/>
    构造方法不会被子类继承；<br/>
    convenient constructors；<br/>
    named constructors；<br/>
    initializer list；<br/>
    initializer list -> superclass&rsquo;s no-arg constructor -> main class&rsquo;s no-arg constructor；<br/>
    redirecting constructors；<br/>
    factory constructors；</p>

<h2>2019.05.14</h2>

<p>使用SingleChildScrollView避免超出边界。<br/>
本地图片路径名称。<br/>
shared_preference 引入问题，增加pod xcconfig，编码问题。  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201905/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201905/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201905/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201904/">iOS知识小集-201904</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:24:54+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:24 am</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201904/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201904/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.04.01</h2>

<p>企业版本打包流程：<br/>
  1、code sign identity，创建、或者导出p12；<br/>
  2、创建APP ID；<br/>
  3、创建ProvisioningProfile，下载安装；<br/>
  4、archive、inhouse；</p>

<p>build can&rsquo;t find simulator, need to update cocoapod.</p>

<h2>2019.04.03</h2>

<p>iOS 打包</p>

<p><code>xcodebuild archive -configuration $configuration VERBOSE_SCRIPT_LOGGING=YES -workspace ios/$scheme.xcworkspace -scheme $scheme -archivePath ./out/"$build_type".xcarchive</code></p>

<p><code>xcodebuild -exportArchive \
-allowProvisioningUpdates \
-archivePath ./out/"$build_type".xcarchive \
-exportOptionsPlist ios/$ExportOptions.plist \
-exportPath ./out/</code></p>

<p>添加 <strong>configuration</strong> 并且创建对应的 <strong>.xcconfig</strong> 文件需要添加到 Flutter 目录下<br/>
命令打包、导出成功；<br/>
需要配置相应的编译配置；<br/>
生成 <strong>ExportOptions.plis </strong><br/>
配置 <strong>$scheme $configuration $build_type</strong><br/>
注意 <strong>archive路径问题</strong><br/>
忽略已经在git中的文件 <strong>.gitignore</strong> 需要删除对应文件才生效 <code>git rm -r file</code><br/>
服务器安装 <strong>ProvisioningProfile</strong> 否则无法打包<br/>
jenkins <strong>workspace</strong>  仿照 vpa_release 创建 jenkins 工程<br/>
<strong>Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</strong> 需要打开 <strong>keychain</strong></p>

<h2>2019.04.11</h2>

<p>Android 打包</p>

<p>添加 <strong>安卓模拟器 </strong></p>

<p><strong>initializing gradle</strong> 巨慢无比  <strong>替换为本地gradle版本</strong><br/>
distributionUrl=https://services.gradle.org/distributions/gradle-4.6-all.zip</p>

<p><strong>Error Domain=DVTPortalServiceErrorDomain Code=1100 &ldquo;Your session has expired.  Please log in.&rdquo;</strong> 重新登录账号</p>

<p>生成 <strong>key.jks</strong> 文件 <code>keytool -genkey -v -keystore ~/key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias key</code><br/>
添加 <strong><app dir>/android/key.properties</strong> <em>不要加入到git中</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>storePassword=&lt;password from previous step&gt;
</span><span class='line'>keyPassword=&lt;password from previous step&gt;
</span><span class='line'>keyAlias=key
</span><span class='line'>storeFile=&lt;location of the key store file, e.g. /Users/&lt;user name&gt;/key.jks&gt;</span></code></pre></td></tr></table></div></figure>


<p>修改 <strong><app dir>/android/app/build.gradle</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">def</span> <span class="n">keystorePropertiesFile</span> <span class="o">=</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="s">&quot;key.properties&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">def</span> <span class="n">keystoreProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Properties</span><span class="o">()</span>
</span><span class='line'><span class="n">keystoreProperties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="n">keystorePropertiesFile</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">signingConfigs</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">release</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">keyAlias</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="err">&#39;</span><span class="n">keyAlias</span><span class="err">&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">keyPassword</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="err">&#39;</span><span class="n">keyPassword</span><span class="err">&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">storeFile</span> <span class="nf">file</span><span class="o">(</span><span class="n">keystoreProperties</span><span class="o">[</span><span class="err">&#39;</span><span class="n">storeFile</span><span class="err">&#39;</span><span class="o">])</span>
</span><span class='line'>        <span class="n">storePassword</span> <span class="n">keystoreProperties</span><span class="o">[</span><span class="err">&#39;</span><span class="n">storePassword</span><span class="err">&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">buildTypes</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">release</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="o">.</span><span class="na">release</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行 <strong>flutter build apk</strong> 生成 apk 文件，运行 <strong>flutter install</strong> 安装至手机。</p>

<h2>2019.04.09</h2>

<p>耳机颈部操<br/>
耳机配对：先配对经典蓝牙，再配对对应BLE<br/>
耳机通信：<strong>先注册服务，再接收耳机通知</strong></p>

<h2>2019.04.22</h2>

<p>flutter <br/>
    1、stateful widget、stateless widget；<br/>
    2、animation；<br/>
    3、paint；<br/>
    4、opacity；<br/>
    5、layout；<br/>
    6、navigator &amp; route；<br/>
    7、network request；<br/>
    8、ProgressIndicator；<br/>
    9、asset、AssetBundle；<br/>
    10、localizable、flutter_localizations（itl）；<br/>
    11、life circle；<br/>
    12、listview、ListView.Builder；<br/>
    13、gesture、GestureDetector；<br/>
    14、theme、font；<br/>
    15、text filed；<br/>
    16、GPS（location）、camera（image_picker）、userdefault（SharePreferences）、database（SQFlite）、notification（firebase_messaging）；<br/>
    17、SharePreferences；<br/>
    18、<a href="https://medium.com/flutter-io/do-flutter-apps-dream-of-platform-aware-widgets-7d7ed7b4624d">平台 UI 定制</a>；<br/>
    19、<a href="https://github.com/flutter/samples/tree/master/jsonexample/lib">json</a></p>

<h2>2019.04.24</h2>

<p>flutter_go</p>

<h4>Application：</h4>

<p>​    router：路由<br/>
​    tabbarController：tab bar<br/>
​    sharedPeference：共享存储</p>

<h4>Router：</h4>

<p>​    路由管理：<a href="https://pub.dartlang.org/packages/fluro">fluro</a><br/>
​    定义路由名称：routers.dart<br/>
​    定义路由事件：routers_handler.dart</p>

<h4>TabBarController：</h4>

<p>​    创建TabController：<code>controll = TabController(initialIndex: 0, vsync: this, length: 4)</code>；<br/>
​    绑定TabController：<code>TabBarView(controller: controller, children: &lt;Widget&gt;[Page1(), Page2(), Page3()])</code>；<br/>
​    创建bottomNavigationBar：<code>Material( child: TabBar(controller: controller, tabs: myTabs))</code>；</p>

<h4>Widgets：</h4>

<h5>ThemeData：</h5>

<p>​        颜色：primaryColor，backgroundColor，accentColor；<br/>
​        字体：textTheme；<br/>
​        图标：iconTheme；</p>

<h5>Color：</h5>

<p>​        定义全局 ThemeColor：<code>const int ThemeColor = 0xFFC91B3A</code>；<br/>
​        通过颜色值创建颜色：<code>Color(ThemeColor)</code>；<br/>
​        获取ThemeColor：<code>Theme.of(context).primaryColor</code>；</p>

<h5>PageController：</h5>

<p>​        创建controller：<code>controller = PageController(initialPage: index)</code>；<br/>
​        销毁controller：<code>controller.dispose()</code>；<br/>
​        操作controller：<code>controller.animateToPage(1, duration: Duration(milliseconds: 300), curve: Curves.linear)</code>；<br/>
​        绑定controller：<code>PageView(controller: controller, onPageChanged: _onPageChanged, children: _buildItems)</code><br/>
​        indicator：Row of circles；</p>

<h5>ListRefresh：</h5>

<p>​        异步方法，当<code>mounted = true</code>时，才能调用<code>setState</code>；<br/>
​        分页数据请求：requestApi<br/>
​        cell：renderItem<br/>
​        headerView：headerView</p>

<h4>NetUtils</h4>

<p>​    网络请求：<a href="https://pub.dartlang.org/packages/dio">dio</a>
​    get<br/>
​    post<br/>
​    json<br/>
​    protobuf</p>

<h4>Utils</h4>

<p>​    时间、日期</p>

<h4>Timer：</h4>

<p>​    创建Timer：<code>timer = Timer.periodic(Duration(seconds: 5), (timer) { /// do something })</code>；<br/>
​    销毁Timer：<code>timer.cancel()</code>；  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201904/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201904/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201904/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201903/">iOS知识小集-201903</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-17T11:18:45+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:18 am</span></time>
        
           | <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201903/#disqus_thread"
             data-disqus-identifier="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201903/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2019.03.08</h2>

<h3>Flutter开发流程搭建</h3>

<p>目标：<br/>
    实现Flutter对原来Native工程的非侵入式集成 —— 通过pod集成；<br/>
    保证Flutter编译环境的唯一性 —— 通过服务器编译产生构建产物；<br/>
    实现了Flutter的持续集成 —— 自动编译flutter代码并同步flutter构建产物；</p>

<ol>
<li>在打包机器安装 flutter 开发环境；√</li>
</ol>


<p>下载 <a href="https://flutter.dev/docs/development/tools/sdk/archive?tab=macos#macos">Flutter SDK</a>；</p>

<p>配置环境变量：<code>export PATH=[FLUTTER_INSTALL_PATH]/flutter/bin:$PATH</code>；</p>

<p>安装Xcode、Android Studio；</p>

<p><code>flutter doctor</code><br/>
  iOS：<br/>
    brew update<br/>
    brew install &ndash;HEAD usbmuxd<br/>
    brew link usbmuxd<br/>
    brew install &ndash;HEAD libimobiledevice<br/>
    brew install ideviceinstaller<br/>
    brew install ios-deploy<br/>
  Android：<br/>
    update Android SDK 28<br/>
  Plugins：<br/>
    Flutter<br/>
    Dart</p>

<ol>
<li><p>新建 gerrit 测试项目 flutter_test、flutter_sdk_test、flutter_pod_test；√</p></li>
<li><p>新建 jenkins 打包项目 flutter_test；√</p></li>
<li><p>添加 Flutter 自动编译脚本；√</p>

<p> <strong>jenkins源码配置：Refspec：refs/changes/<em>:refs/changes/</em></strong><br/>
 <strong>添加环境变量：export PATH=/Users/Mobvoi/Library/flutter/bin:$PATH</strong><br/>
 <strong>自动使用company签名：修改源工程配置</strong><br/>
 修改项目 Bundle ID，使用公司证书签名，需要区分证书；<br/>
 <code>flutter build ios</code> 编译 release 版本；<br/>
 <code>flutter build ios --debug</code> 编译 debug 版本；<br/>
 编译产物在 <code>project_dir/ios/Flutter</code> 目录下；<br/>
 将编译产物导出至 <code>project_dir/FlutterSDK</code> 目录下；<br/>
 build.sh</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># keychain 访问权限</span>
</span><span class='line'>security unlock-keychain -p mobvoi login.keychain
</span><span class='line'>
</span><span class='line'><span class="c"># 添加环境变量</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/Users/Mobvoi/Library/flutter/bin:<span class="nv">$PATH</span>
</span><span class='line'>
</span><span class='line'>//  获取当前目录
</span><span class='line'><span class="nv">project_dir</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="s2">&quot;$(dirname &quot;</span><span class="nv">$0</span><span class="s2">&quot;)&quot;</span><span class="p">;</span><span class="nb">pwd</span><span class="k">)</span>
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>
</span><span class='line'>//  release产物路径
</span><span class='line'><span class="nv">release_sdk_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>/FlutterSDK/Release
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">release_sdk_dir</span><span class="k">}</span>
</span><span class='line'>//  debug产物路径
</span><span class='line'><span class="nv">debug_sdk_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>/FlutterSDK/Debug
</span><span class='line'><span class="nb">echo</span> <span class="k">${</span><span class="nv">debug_sdk_dir</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>//  清空上次编译产物
</span><span class='line'>rm -rf <span class="k">${</span><span class="nv">release_sdk_dir</span><span class="k">}</span>
</span><span class='line'>rm -rf <span class="k">${</span><span class="nv">debug_sdk_dir</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>//  创建产物目录
</span><span class='line'>mkdir -p <span class="k">${</span><span class="nv">release_sdk_dir</span><span class="k">}</span>
</span><span class='line'>mkdir -p <span class="k">${</span><span class="nv">debug_sdk_dir</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>//  使用release证书编译
</span><span class='line'><span class="c">#flutter build ios</span>
</span><span class='line'>
</span><span class='line'>//  导出release编译产物
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Start exporting flutter release sdk done!&quot;</span>
</span><span class='line'>cp -rf <span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>/ios/Flutter/*.framework <span class="k">${</span><span class="nv">release_sdk_dir</span><span class="k">}</span>
</span><span class='line'>cp -rf <span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>/ios/Flutter/flutter_assets <span class="k">${</span><span class="nv">release_sdk_dir</span><span class="k">}</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Export flutter release sdk done!&quot;</span>
</span><span class='line'>
</span><span class='line'>//  使用debug证书编译
</span><span class='line'><span class="c">#flutter build ios --debug</span>
</span><span class='line'>
</span><span class='line'>//  导出debug编译产物
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Start exporting flutter release sdk done!&quot;</span>
</span><span class='line'>cp -rf <span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>/ios/Flutter/*.framework <span class="k">${</span><span class="nv">debug_sdk_dir</span><span class="k">}</span>
</span><span class='line'>cp -rf <span class="k">${</span><span class="nv">project_dir</span><span class="k">}</span>/ios/Flutter/flutter_assets <span class="k">${</span><span class="nv">debug_sdk_dir</span><span class="k">}</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Export flutter debug sdk done!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>创建 pod 包含 flutter 工程 √<br/>
创建pod：<code>pod spec create flutter_sdk</code><br/>
修改配置文件：</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>s.prepare_command <span class="o">=</span> <span class="s2">&quot;build.sh&quot;</span>
</span><span class='line'>s.vendored_frameworks <span class="o">=</span> <span class="s1">&#39;Framework/Debug/*.framework&#39;</span>
</span><span class='line'>s.resources <span class="o">=</span> <span class="s1">&#39;Framework/Debug/flutter_assets&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>server 编译生成产物<br/>
pod 下载产物</p>

<p>检查依赖 <code>pod lib lint --verbose --no-clean --allow-warnings --sources=MobvoiPods,master</code>
推送到仓库 <code>pod repo push MobvoiPods flutter_test.podspec --allow-warnings --sources=MobvoiPods,master</code></p>

<ol>
<li><p>flutter_test 编译成功后将编译产物上传至 flutter_sdk_test，区分 iOS 和 Android；
 export.sh</p></li>
<li><p>构建 flutter_pod_test 自动从 flutter_sdk_test 下载iOS编译产物，区分 release 和 debug；
 download.sh</p></li>
<li><p>one 工程依赖 flutter_pod_test，打包时区分 release 和 debug；</p></li>
<li><p>时序图：</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>@startuml
</span><span class='line'>actor Light
</span><span class='line'>participant local_FlutterSDK
</span><span class='line'>participant gerrit_FlutterSDK <span class="c">#99FF99</span>
</span><span class='line'>participant jenkins_FlutterSDK <span class="c">#FF9999</span>
</span><span class='line'>participant <span class="nv">local_One</span>
</span><span class='line'>
</span><span class='line'><span class="o">==</span> <span class="nv">Flutter</span> <span class="o">==</span>
</span><span class='line'>
</span><span class='line'>Light -&gt; local_FlutterSDK : Develop
</span><span class='line'>local_FlutterSDK -&gt; gerrit_FlutterSDK : Push to gerrit
</span><span class='line'>gerrit_FlutterSDK -&gt; jenkins_FlutterSDK : Trigger compiling
</span><span class='line'>note right <span class="c">#99FF99</span>
</span><span class='line'>  build_debug.sh
</span><span class='line'>  build flutter debug SDK
</span><span class='line'>end note
</span><span class='line'>jenkins_FlutterSDK --&gt; gerrit_FlutterSDK : Success
</span><span class='line'>gerrit_FlutterSDK --&gt; Light : Success
</span><span class='line'>Light -&gt; gerrit_FlutterSDK : Merge code
</span><span class='line'>gerrit_FlutterSDK -&gt; jenkins_FlutterSDK : Trigger compiling
</span><span class='line'>note right <span class="c">#99FF99</span>
</span><span class='line'>  export_debug.sh
</span><span class='line'>  build flutter debug SDK
</span><span class='line'>  <span class="nb">export </span>flutter debug SDK
</span><span class='line'>  update pod version
</span><span class='line'>end note
</span><span class='line'>jenkins_FlutterSDK --&gt; gerrit_FlutterSDK : Success
</span><span class='line'>gerrit_FlutterSDK --&gt; Light : <span class="nv">Success</span>
</span><span class='line'>
</span><span class='line'><span class="o">==</span> <span class="nv">iOS</span> <span class="o">==</span>
</span><span class='line'>
</span><span class='line'>Light -&gt; local_One : Pod update
</span><span class='line'>local_One -&gt; jenkins_FlutterSDK : Fetch flutter SDK
</span><span class='line'>note right <span class="c">#99FF99</span>
</span><span class='line'>  FlutterSDK.podspec
</span><span class='line'>  s.vendored_frameworks <span class="o">=</span> <span class="s1">&#39;Framework/*.framework&#39;</span>
</span><span class='line'>  s.resources <span class="o">=</span> <span class="s1">&#39;Framework/flutter_assets&#39;</span>
</span><span class='line'>end note
</span><span class='line'>jenkins_FlutterSDK --&gt; local_One : Success
</span><span class='line'>@enduml
</span></code></pre></td></tr></table></div></figure>


<p>学习资料：<a href="https://github.com/alibaba/flutter-go">https://github.com/alibaba/flutter-go</a></p>

<h2>2019.03.22</h2>

<ol>
<li>运行flutter release 版本；</li>
<li>从网上下载的flutter工程需要配置dart 和 flutter SDK路径；</li>
<li>podspec需要指定系统版本；</li>
<li>pod lib lint 和 pod spec lint；</li>
<li>flutter 版本需保持一致；</li>
<li>flutter upgrade 升级；</li>
<li>将 App.framework 和 Flutter.framework 上传；</li>
<li>添加flutter编译时脚本；</li>
<li>framework 和 static library 有什么区别；</li>
</ol>


<h3>PodFile</h3>

<h4>Root Options</h4>

<p><code>install!</code>：指定<code>pod install</code>时执行的方法和选项。</p>

<h4>Dependencies</h4>

<p><code>pod</code>：指定工程的依赖。</p>

<ul>
<li><code>:configurations =&gt; ['Debug','Release']</code>：根据编译配置选择性安装依赖。</li>
<li><code>:source =&gt; 'https://github.com/CocoaPods/Specs.git'</code>：指定pod库的来源。</li>
<li><code>:subspecs =&gt; ['Subspec1', 'Subspec2']</code>：指定需要安装的Subspec。</li>
<li><code>:path =&gt; '~/Documents/LocalPod'</code>：指定安装本地Pod。</li>
<li><code>:git =&gt; 'https://github.com/gowalla/AFNetworking.git', :branch =&gt; 'dev', :tag =&gt; '0.1.0'</code>：指定安装的库地址及分支或标签。</li>
<li><code>:podspec =&gt; https://example.com/JSONKit.podspec</code>：指定podspec的来源。</li>
<li><code>:inhibit_warnings =&gt; true</code>：屏蔽Pod中语法警告。</li>
</ul>


<p><code>podspec</code>：指定podspec文件的来源。</p>

<p><code>target 'ProjectTargetName' do ... end</code>：指定Target的依赖。</p>

<p><code>script_phase :name =&gt; 'HelloWorldScript', :script =&gt; 'echo "Hello World"', :shell_path =&gt; '/usr/bin/ruby'</code>：指定运行脚本。</p>

<p><code>abstract_target 'AbstractTargetName' do ... end</code>：指定抽象Target的依赖，方便多个Target继承。</p>

<p><code>inherit!</code>：指定依赖继承。</p>

<ul>
<li><code>:complete</code>：完全继承父亲行为。</li>
<li><code>:none</code>：不继承父亲行为。</li>
<li><code>:search_paths</code>：只继承父亲库的搜索路径。</li>
</ul>


<h4>Target Configuration</h4>

<p><code>platform :ios, '9.0'</code>：设置系统版本。</p>

<p><code>project 'TestProject', 'App Store' =&gt; :release, 'Test' =&gt; :debug</code>：根据工程build configuration选择debug或release版本。</p>

<p><code>inhibit_all_warnings!</code>：屏蔽所有Pod中语法警告。</p>

<p><code>use_modular_headers!</code>：指定静态库使用modular headers。</p>

<p><code>use_frameworks!</code>：指定使用frameworks而不是静态库。</p>

<h4>Workspace</h4>

<p><code>workspace 'MyWorkspace'</code>：指定workspace。</p>

<p><code>generate_bridge_support!</code>：指定生成BridgeSupport文件。</p>

<p><code>set_arc_compatibility_flag!</code>：指定需要添加<code>-fobjc-arc</code>flag。</p>

<h4>Source</h4>

<p><code>source 'https://github.com/CocoaPods/Specs.git'</code>：指定全局仓库地址。</p>

<h4>Hooks</h4>

<p><code>plugin 'cocoapods-keys', :keyring =&gt; 'Eidolon'</code>：指定安装时需要的插件。</p>

<p><code>pre_install do |installer| ... end</code>：Pod下载好，安装前，执行。</p>

<p><code>post_install od |installer| ... end</code>：Pod安装好，生成Xcode project时执行。</p>

<p><code>supports_swift_versions</code>：指定所需要的Swift版本支持。</p>

<h3>Podspec</h3>

<h4>Root specification</h4>

<p><code>spec.source</code>：指定Pod库的源地址。</p>

<ul>
<li><code>:git =&gt; :tag, :branch, :commit, :submodules</code></li>
<li><code>:svn =&gt; :folder, :tag, :revision</code></li>
<li><code>:hg =&gt; :revision</code></li>
<li><code>:http =&gt; :flatten, :type, :sha256, :sha1</code></li>
</ul>


<p><code>spec.prepare_command</code>：当Pod下载好之后执行的脚本，可以用来创建、删除、修改下载好的文件。脚本会在Pod清除前和Pod工程创建前执行，目录是Pod的根目录。</p>

<h4>Platform</h4>

<p><code>spec.platform = :ios, '9.0'</code>：指定Pod支持的系统平台和版本。<br/>
<code>spec.ios.deployment_target = '9.0'</code>：指定支持的系统平台的最低版本。</p>

<h4>Build Settings</h4>

<p><code>spec.dependency 'AFNetworking', '~&gt; 1.0'</code>：指定依赖的第三方库。<br/>
<code>spec.requires_arc = true</code>：指定需要支持ARC。<br/>
<code>spec.framework = 'QuartzCore'</code>：指定Target需要链接的系统库。 <br/>
<code>spec.library = 'xml2'</code>：指定Target需要链接的系统库。<br/>
<code>spec.weak_framework = 'Twitter'</code>：指定Target需要weak链接的库。<br/>
<code>spec.compiler_flags = '-DOS_OBJECT_USE_OBJC=0'</code>：传递给编译器的标识列表。<br/>
<code>spec.prefix_header_file = false</code>：指定是否引入公共头文件。<br/>
<code>spec.script_phase = {}</code>：当Pod编译时执行的脚本。</p>

<h4>File patterns</h4>

<p><code>*</code>：匹配任何文件。<br/>
<code>**</code>：递归的匹配目录。<br/>
<code>?</code>：匹配任何一个字符。<br/>
<code>[set]</code>：匹配set中的任何一个字符。<br/>
<code>{p,q}</code>：匹配字符p或者字符q。</p>

<p><code>spec.source_files = 'Classes/**/*.{h,m}'</code>：指定Pod的源文件。<br/>
<code>spec.public_header_files = 'Headers/Public/*.h'</code>：指定公共头文件。<br/>
<code>spec.private_header_files = 'Headers/Private/*.h'</code>：指定私有头文件。<br/>
<code>spec.vendored_frameworks = 'Frameworks/MyFramework.framework'</code>：与Pod一起绑定的framework。<br/>
<code>spec.vendored_libraries = 'libProj4.a'</code>：与Pod一起绑定的静态库。<br/>
<code>spec.resources = '[Images/*.png]'</code>：需要拷贝到Target中的资源文件。<br/>
<code>spec.exclude_files = 'Classes/osx'</code>：需要忽略的文件。<br/>
<code>spec.preserve_paths = 'Important.text'</code>：下载后不应该被删除的文件。  <p class='post-footer'>
  原始地址：
  <a href='http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201903/'><a href="http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201903/">http://sxgfxm.github.io/blog/2020/01/17/ioszhi-shi-xiao-ji-201903/</a></a><br/>
  written by <a href='http://sxgfxm.github.io'>Light</a>
  &nbsp;posted at <a href='http://sxgfxm.github.io'><a href="http://sxgfxm.github.io">http://sxgfxm.github.io</a></a>
  </p></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
 <h1>Introduction</h1>

<li>
	<span style="color:#222222;font-family:inherit;font-size:18px;font-style:inherit;font-weight:inherit;line-height:1.5;">Light</br></span>
	<span style="font-family:inherit;font-style:inherit;font-weight:inherit;color:#222222;font-size:18px;line-height:1.5;">iOS研发工程师</br></span>
	<span style="font-family:inherit;font-style:inherit;font-weight:inherit;color:#222222;font-size:18px;line-height:1.5;">现就职于 出门问问</br></span>
  <span style="font-family:inherit;font-style:inherit;font-weight:inherit;color:#222222;font-size:18px;line-height:1.5;">E-mail: sxgfxm@gmail.com</br></span>
</li>

</section>
<section>
 <h1>Categories</h1>
 <ul id="categories">
   <li class='category'><a href='/blog/categories/componentkit/'>componentkit (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (84)</a></li>
<li class='category'><a href='/blog/categories/leetcode/'>leetcode (9)</a></li>
<li class='category'><a href='/blog/categories/markdown/'>markdown (1)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (3)</a></li>
<li class='category'><a href='/blog/categories/reactiveobjc/'>reactiveobjc (2)</a></li>

 </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201912/">iOS知识小集-201912</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201911/">iOS知识小集-201911</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201910/">iOS知识小集-201910</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/17/ioszhi-shi-xiao-ji-201909/">iOS知识小集-201909</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/17/zhi-shi-xiao-ji-201908/">知识小集-201908</a>
      </li>
    
  </ul>
</section>
<section>
 <h1>他山之石</h1>
	<li>
		<a href="http://southpeak.github.io/">南峰子的技术博客</a></br>
	</li>
	<li>
		<a href="http://www.tutorialspoint.com/index.htm">TutorailSpoint</a></br>
	</li>
	<li>
		<a href="http://stackoverflow.com/">StackOverflow</a></br>
	</li>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sxgfxm">@sxgfxm</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sxgfxm',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section>
 <h1>Visitors</h1>
	<a href="http://info.flagcounter.com/CVgH"><img src="http://s09.flagcounter.com/count2/CVgH/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_10/viewers_0/labels_0/pageviews_0/flags_0/percent_0/" alt="Flag Counter" border="0"></a>
</section>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Light -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86198628-1', 'auto');
  ga('send', 'pageview');

</script>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lights-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
